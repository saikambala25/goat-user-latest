<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LivestockMart - User App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            750: '#2d3748',
                            850: '#1a202c',
                            900: '#111827',
                            950: '#030712',
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overscroll-behavior-y: contain; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Auth Styles */
        .auth-glass { background: rgba(17, 24, 39, 0.95); backdrop-filter: blur(18px); }
        .auth-card { position: relative; overflow-y: auto; overflow-x: hidden; max-height: 85vh; }
        .auth-panel { transition: transform 0.45s ease, opacity 0.45s ease; width: 100%; }
        .auth-panel-register { position: absolute; top: 0; left: 0; transform: translateX(100%); opacity: 0; pointer-events: none; }
        
        .auth-card.show-register .auth-panel-login { transform: translateX(-100%); opacity: 0; pointer-events: none; }
        .auth-card.show-register .auth-panel-register { transform: translateX(0); opacity: 1; pointer-events: auto; position: relative; }
        
        #sidebar { transition: transform 0.3s ease-in-out; }
        
        .lm-flyin { transform: translateY(18px); opacity: 0; transition: transform 360ms cubic-bezier(.2,.9,.2,1), opacity 360ms; }
        .lm-flyin.lm-show { transform: translateY(0); opacity: 1; }
        
        .page-enter { opacity: 0; transform: translateY(20px); }
        .page-enter-active { opacity: 1; transform: translateY(0); transition: all .6s cubic-bezier(.16,.67,.43,1); }

        .card-premium { transition: transform .35s cubic-bezier(.2,.9,.2,1), box-shadow .35s; }
        .card-premium:hover { transform: translateY(-6px) scale(1.03); box-shadow: 0 18px 40px rgba(0,0,0,0.15); }

        .reveal { opacity: 0; transform: translateY(25px); transition: all .7s cubic-bezier(.2,.9,.2,1); }
        .reveal-visible { opacity: 1; transform: translateY(0); }

        .toast-anim { transform: translateX(20px); opacity: 0; animation: toastIn .4s forwards, toastOut .4s forwards 3s; }
        @keyframes toastIn { to { transform: translateX(0); opacity: 1; } }
        @keyframes toastOut { to { transform: translateX(30px); opacity: 0; } }

        .btn-press { transition: transform .15s ease, box-shadow .3s ease; }
        .btn-press:active { transform: scale(.96); }
        .btn-glow:hover { box-shadow: 0 0 12px rgba(16,185,129,0.6); }

        #pull-refresh-indicator {
            position: fixed; top: -50px; left: 0; right: 0; height: 50px; display: flex; align-items: center; justify-content: center; z-index: 100; transition: top 0.2s; pointer-events: none;
        }
        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(16, 185, 129, 0.3); border-radius: 50%; border-top-color: #10b981; animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .pay-icon-btn { transition: transform 0.2s, border-color 0.2s; }
        .pay-icon-btn:hover { transform: scale(1.05); border-color: #10b981; }

        /* Image Slider Styles */
        .image-slider-container { position: relative; overflow: hidden; }
        .image-slider-track { display: flex; transition: transform 0.3s ease-in-out; }
        .slider-image { flex: 0 0 100%; width: 100%; }
        .slider-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; padding: 8px 12px; cursor: pointer; z-index: 10; border-radius: 50%; }
        .slider-nav:hover { background: rgba(0,0,0,0.7); }
        .slider-nav-prev { left: 8px; }
        .slider-nav-next { right: 8px; }
        .slider-dots { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10; }
        .slider-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255,255,255,0.5); cursor: pointer; transition: background 0.3s; }
        .slider-dot.active { background: white; }
    
/* Poster-Style Marquee: Fills card while keeping details */
.lm-marquee-container {
  position: relative;
  overflow: hidden;
  padding: 2rem 0;
}

.lm-marquee-track {
  display: flex;
  align-items: center;
  width: max-content;
  gap: 1.5rem;
  animation: lm-scroll-left 50s linear infinite;
}

.lm-marquee-track:hover {
  animation-play-state: paused;
}

.lm-media-card {
  /* Taller "Poster" aspect ratio (4:5) */
  width: 240px; 
  height: 320px;
  border-radius: 1.5rem;
  overflow: hidden;
  position: relative;
  flex-shrink: 0;
  background: #111;
  border: 1px solid rgba(255, 255, 255, 0.15);
  box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
}

@media (min-width: 768px) {
  .lm-media-card {
    width: 320px;
    height: 420px;
  }
}

/* The Blurred Background to "Fill" the card */
.lm-media-card::before {
  content: "";
  position: absolute;
  inset: 0;
  background-image: var(--bg-img);
  background-size: cover;
  background-position: center;
  filter: blur(20px) brightness(0.5);
  transform: scale(1.1);
  z-index: 1;
}

.lm-media-card img,
.lm-media-card video {
  position: relative;
  width: 100%;
  height: 100%;
  /* Ensures no cropping of text/info */
  object-fit: contain; 
  z-index: 2;
  display: block;
}

@keyframes lm-scroll-left {
  0%   { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

</style>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="icon-192.png">
    
</head>
<body class="h-screen bg-gray-900 text-gray-100 overflow-hidden transition-colors duration-200">
    
    <div id="pull-refresh-indicator">
        <div class="spinner"></div>
    </div>

    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

    <div id="toast-container" class="fixed top-4 right-4 z-[9999] space-y-3 pointer-events-none"></div>
    
    <div id="address-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 px-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md text-gray-800 dark:text-gray-100 shadow-2xl relative max-h-[90vh] overflow-y-auto border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold" id="address-modal-title">Shipping Address</h3>
                <button onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Enter the address where you want to receive your livestock.</p>
            <div class="pr-1">
                <form id="address-form" class="space-y-3" onsubmit="submitAddress(event)">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                        <input id="addr-name" type="text" class="mt-1 w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Phone Number</label>
                        <input id="addr-phone" type="tel" pattern="[0-9]{10}" maxlength="10"
                            class="mt-1 w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            placeholder="10-digit mobile number" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Address Line</label>
                        <textarea id="addr-line" class="mt-1 w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" rows="2" required></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">City</label>
                            <input id="addr-city" type="text" class="mt-1 w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">State</label>
                            <input id="addr-state" type="text" class="mt-1 w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 dark:text-gray-300">Pincode</label>
                        <input id="addr-pincode" type="tel" pattern="[0-9]{6}" maxlength="6"
                            class="mt-1 w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
                            placeholder="6-digit pincode" required>
                    </div>
                    <div class="mt-4 flex justify-end gap-3 pb-2">
                        <button type="button" onclick="closeAddressModal()" class="px-4 py-2 text-sm rounded-lg border border-gray-200 dark:border-gray-600 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 shadow-md">
                            Save & Continue
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="track-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 px-4 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-lg text-gray-800 dark:text-gray-100 shadow-2xl relative border border-gray-200 dark:border-gray-700">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-bold">Track Order</h3>
                <button onclick="closeTrackModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="track-content" class="space-y-6"></div>
        </div>
    </div>
    
    <div id="auth-screen" class="hidden fixed inset-0 z-40 flex items-center justify-center px-4 bg-gradient-to-br from-green-900 via-gray-900 to-black overflow-y-auto py-8">
        <div class="max-w-5xl w-full grid grid-cols-1 md:grid-cols-2 gap-8 items-stretch my-auto">
            
            <div class="hidden md:flex flex-col justify-between text-white p-8 rounded-3xl relative overflow-hidden bg-emerald-900/40 backdrop-blur-md border border-white/10">
                <div class="absolute inset-0 z-0 opacity-40">
                    <img src="IMG-20251225-WA0026.jpg" alt="Background" class="w-full h-full object-cover">
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-12 h-12 bg-white rounded-full p-1 shadow-lg flex-shrink-0">
                            <img src="IMG20251229120150.jpg" alt="Logo" class="w-full h-full object-contain rounded-full">
                        </div>
                        <span class="text-3xl font-bold tracking-tight">LivestockMart</span>
                    </div>
                    <h1 class="text-4xl lg:text-5xl font-extrabold leading-tight mb-6">
                        Premium Quality <br><span class="text-emerald-400">Sheep & Goats</span>
                    </h1>
                    <p class="text-lg text-emerald-50/90 mb-8 max-w-md leading-relaxed">
                        Join India's premier livestock marketplace. We provide doorstep delivery of verified, high-quality breeds sourced directly from expert breeders.
                    </p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white/10 p-4 rounded-2xl border border-white/10">
                            <p class="text-2xl font-bold text-emerald-400">500 OFF</p>
                            <p class="text-xs text-emerald-100/70 uppercase tracking-wider">On First Order</p>
                        </div>
                        <div class="bg-white/10 p-4 rounded-2xl border border-white/10">
                            <p class="text-2xl font-bold text-emerald-400">100%</p>
                            <p class="text-xs text-emerald-100/70 uppercase tracking-wider">Verified Health</p>
                        </div>
                    </div>
                </div>
                <div class="relative z-10 pt-8 border-t border-white/10">
                    <p class="text-sm font-medium text-emerald-200 mb-2">Need immediate assistance?</p>
                    <div class="flex gap-6 text-sm font-bold">
                        <span>9000274439</span>
                        <span>9908817975</span>
                    </div>
                </div>
            </div>

            
            <div class="md:hidden mb-6 rounded-3xl overflow-hidden shadow-xl border border-white/10 relative h-48">
                <img src="IMG-20251225-WA0026.jpg" alt="Livestock" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent flex flex-col justify-end p-4">
                    <p class="text-emerald-400 font-bold text-sm">Welcome to LivestockMart</p>
                    <h2 class="text-white text-xl font-bold">Premium Sheep & Goats</h2>
                </div>
            </div>
<div id="auth-card" class="auth-card auth-glass rounded-3xl p-6 sm:p-8 shadow-2xl border border-white/10 hide-scrollbar">
                <div class="auth-panel auth-panel-login">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-9 h-9 rounded-full bg-emerald-500/20 flex items-center justify-center">
                            <i data-lucide="lock" class="w-4 h-4 text-emerald-400"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-semibold text-white">Welcome back</h2>
                            <p class="text-xs text-gray-300">Sign in to your dashboard</p>
                        </div>
                    </div>
                    <form id="login-form" class="space-y-4 mt-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Email</label>
                            <input id="login-email" type="email" required
                                   class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="you@example.com">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Password</label>
                            <input id="login-password" type="password" required
                                   class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-white py-2.5 transition-transform active:scale-[0.98]">
                            <span>Sign in</span>
                        </button>
                    </form>
                    <div class="mt-4 text-xs text-gray-300 flex items-center justify-between">
                        <span>New here?</span>
                        <button type="button" onclick="switchAuthView('register')" class="text-emerald-300 hover:text-emerald-200 font-medium">Create an account</button>
                    </div>
                </div>

                <div class="auth-panel auth-panel-register">
                    <div class="flex items-center justify-between mb-4">
                         <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-emerald-500/20 flex items-center justify-center">
                                <i data-lucide="user-plus" class="w-4 h-4 text-emerald-400"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-semibold text-white">Create account</h2>
                                <p class="text-xs text-gray-300">Join the marketplace</p>
                            </div>
                        </div>
                        <button onclick="switchAuthView('login')" class="text-gray-400 hover:text-white p-2">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <form id="register-form" class="space-y-4 mt-4">
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Full Name</label>
                            <input id="register-name" type="text" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Name">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Email</label>
                            <input id="register-email" type="email" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Email">
                        </div>
                        <div class="space-y-1.5">
                            <label class="text-xs font-medium text-gray-200">Password</label>
                            <input id="register-password" type="password" required class="w-full rounded-xl bg-gray-900/70 border border-gray-700 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Password">
                        </div>
                        <button type="submit" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-sm font-semibold text-white py-2.5 transition-transform active:scale-[0.98]">
                            <span>Create account</span>
                        </button>
                    </form>
                    <div class="mt-4 text-xs text-gray-300 flex items-center justify-between">
                        <span>Already registered?</span>
                        <button type="button" onclick="switchAuthView('login')" class="text-emerald-300 hover:text-emerald-200 font-medium">Back to login</button>
                    </div>
                </div>
                <div id="auth-error" class="mt-4 text-xs text-red-300 hidden"></div>
            </div>
        </div>
    </div>
    
    <div id="user-app" class="hidden h-[100dvh] w-full bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 flex overflow-hidden transition-colors duration-200">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col transform -translate-x-full md:translate-x-0 md:relative transition-transform duration-200 ease-in-out shadow-xl md:shadow-none h-full">
            <div class="p-6 flex items-center justify-between gap-3 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white rounded-full p-0.5 shadow-sm flex-shrink-0 overflow-hidden"><img src="IMG_20251229_120150.jpg" alt="Logo" class="w-full h-full object-contain rounded-full"></div>
                    <span class="text-xl font-bold text-gray-800 dark:text-white">LivestockMart</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-500 dark:text-gray-400 hover:text-red-500">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <nav class="flex-1 px-4 space-y-2 overflow-y-auto min-h-0 pb-24 md:pb-4">
                <button onclick="router('browse')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="home" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-browse">Browse Livestock</span>
                </button>
                <button onclick="router('dashboard')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-dashboard">My Dashboard</span>
                </button>
                <button onclick="router('cart')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="shopping-cart" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-cart">Shopping Cart</span>
                    <span id="cart-badge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="router('orders')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="package" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-orders">My Orders</span>
                </button>
                <button onclick="router('wishlist')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="heart" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-wishlist">Wishlist</span>
                    <span id="wishlist-badge" class="ml-auto bg-pink-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="router('addresses')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="map-pin" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-addresses">Addresses</span>
                </button>
                <button onclick="router('profile')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="user" class="w-5 h-5 flex-shrink-0"></i> Profile
                </button>
                <button onclick="router('support')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="headphones" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-support">Support</span>
                </button>
                <button onclick="router('about')" class="nav-item w-full flex items-center gap-3 px-4 py-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                    <i data-lucide="info" class="w-5 h-5 flex-shrink-0"></i> <span class="lang-about">About</span>
                </button>
            </nav>
        </aside>

        <main id="main-content" class="flex-1 flex flex-col relative overflow-hidden w-full h-full">
            <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-4 md:px-8 py-4 flex justify-between items-center z-10 sticky top-0 flex-shrink-0 transition-colors">
    <div class="flex items-center gap-3 flex-1 min-w-0 mr-2">
        <button onclick="toggleSidebar()" class="md:hidden text-gray-600 dark:text-gray-300 hover:text-green-600 flex-shrink-0">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <div class="overflow-hidden">
            <h1 id="page-title" class="text-lg md:text-2xl font-bold text-gray-800 dark:text-white truncate">My Dashboard</h1>
            <p class="text-xs md:text-sm text-gray-500 dark:text-gray-400 hidden sm:block" id="current-date"></p>
        </div>
    </div>

    <div class="flex items-center gap-2 md:gap-6 flex-shrink-0">
        
        <div class="relative">
            <button onclick="document.getElementById('lang-menu').classList.toggle('hidden')" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                <i data-lucide="languages" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
            </button>
            <div id="lang-menu" class="absolute right-0 mt-2 w-32 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded-xl shadow-xl py-2 hidden z-50">
                <button onclick="changeLanguage('en')" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200">English</button>
                <button onclick="changeLanguage('te')" class="w-full text-left px-4 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
            </div>
        </div>

        <div class="relative">
            <button id="notification-button" onclick="toggleNotificationMenu()" class="focus:outline-none p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition relative">
                <i data-lucide="bell" class="w-6 h-6 text-gray-600 dark:text-gray-300 pointer-events-none"></i>
                <span id="notification-badge" class="absolute top-1 right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden pointer-events-none">0</span>
            </button>
            <div id="notification-menu"
                 class="absolute right-[-50px] md:right-0 mt-2 w-72 max-w-[90vw] bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl shadow-xl py-2 hidden origin-top-right transform transition-all duration-300 scale-95 opacity-0 z-50">
                <div class="flex justify-between items-center px-4 pt-2 pb-1 border-b border-gray-100 dark:border-gray-700">
                    <h4 class="font-semibold text-sm text-gray-800 dark:text-gray-200">Notifications</h4>
                    <button onclick="clearAllNotifications()" class="text-xs text-blue-500 hover:text-blue-700 disabled:opacity-50" id="clear-all-btn" disabled>Clear All</button>
                </div>
                <div id="notification-list" class="max-h-64 overflow-y-auto space-y-1 p-2"></div>
            </div>
        </div>
        
        <div class="relative cursor-pointer p-1" onclick="router('cart')">
            <i data-lucide="shopping-cart" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i>
            <span id="header-cart-badge" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
        </div>
        
        <div class="relative">
            <button id="profile-button" onclick="toggleProfileMenu()" class="flex items-center gap-2 md:gap-3 focus:outline-none">
                <div id="profile-avatar" class="w-9 h-9 md:w-10 md:h-10 bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300 rounded-full flex items-center justify-center font-bold text-sm md:text-base flex-shrink-0">U</div>
                <div class="hidden md:block text-left">
                    <p id="profile-name" class="text-sm font-semibold truncate max-w-[100px] text-gray-800 dark:text-white">User</p>
                    <p id="profile-meta" class="text-xs text-gray-500 dark:text-gray-400">Welcome</p>
                </div>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500 dark:text-gray-400 hidden md:block"></i>
            </button>
            <div id="profile-menu" class="absolute right-0 mt-2 w-44 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-lg shadow-lg py-1 hidden z-50">
                <button onclick="router('profile'); toggleProfileMenu(false);" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700 flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4"></i> Profile
                </button>
                <button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2">
                    <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                </button>
            </div>
        </div>
    </div>
</header>
            
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-50 dark:bg-gray-900 hide-scrollbar relative pb-24 transition-colors">
                
                <div id="view-dashboard" class="space-y-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex justify-between items-center transition-colors">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">My Orders</p>
                                <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="dash-total-orders">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-full flex items-center justify-center text-xl">üì¶</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex justify-between items-center transition-colors">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Wishlist</p>
                                <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="dash-total-wishlist">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 rounded-full flex items-center justify-center text-xl">‚ù§Ô∏è</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex justify-between items-center transition-colors">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Cart Items</p>
                                <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="dash-total-cart">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 rounded-full flex items-center justify-center text-xl">üõí</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm flex justify-between items-center transition-colors">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Livestock</p>
                                <h3 class="text-2xl font-bold text-gray-800 dark:text-white" id="dash-total-livestock">0</h3>
                            </div>
                            <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full flex items-center justify-center text-xl">üêê</div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-100 dark:border-gray-700 shadow-sm transition-colors">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Spent</p>
                                <h3 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white" id="dash-total-spent">0</h3>
                            </div>
                            <div class="w-12 h-12 md:w-16 md:h-16 bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600 dark:text-yellow-400 rounded-full flex items-center justify-center text-2xl md:text-3xl">üí∞</div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm transition-colors">
                        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="font-bold text-gray-800 dark:text-white lang-recent-orders">Recent Orders</h3>
                        </div>
                        <div class="p-4 md:p-6 space-y-4" id="dash-recent-orders"></div>
                    </div>
                </div>

                <div id="view-browse" class="hidden space-y-6">
                    <div class="flex flex-col md:flex-row gap-4 justify-between">
                        <div class="relative flex-1 w-full md:max-w-md">
                            <i data-lucide="search" class="absolute left-3 top-3 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="renderBrowse()" placeholder="Search by name or breed..." class="w-full pl-10 pr-4 py-2.5 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 bg-white dark:bg-gray-800 text-gray-800 dark:text-white">
                        </div>
                        <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                            <button onclick="filterCategory('All')" class="filter-btn px-4 py-2 bg-gray-800 dark:bg-gray-700 text-white hover:bg-gray-700 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">All</button>
                            <button onclick="filterCategory('Goat')" class="filter-btn px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">Goats</button>
                            <button onclick="filterCategory('Sheep')" class="filter-btn px-4 py-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg text-sm font-medium whitespace-nowrap transition-colors">Sheep</button>
                        </div>
                    </div>
                    <div id="livestock-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="view-cart" class="hidden space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-4 md:p-6 transition-colors">
                        <h3 class="font-bold text-lg mb-6 text-gray-800 dark:text-white">Shopping Cart <span id="cart-count-title" class="text-gray-400 text-sm font-normal">(0 items)</span></h3>
                        <div id="cart-items-container" class="space-y-6"></div>
                        <div class="mt-8 pt-6 border-t border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Total: <span id="cart-total">0</span></h3>
                            <button onclick="checkout()" class="w-full sm:w-auto bg-gray-800 dark:bg-gray-700 text-white px-8 py-3 rounded-lg font-medium hover:bg-gray-900 dark:hover:bg-gray-600 transition lang-checkout">Proceed to Checkout</button>
                        </div>
                    </div>
                </div>
                
                <div id="view-summary" class="hidden space-y-6">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-4 md:p-6 max-w-3xl mx-auto transition-colors">
                        <div class="flex items-center gap-3 mb-6 border-b dark:border-gray-700 pb-4">
                            <button onclick="router('cart')" class="text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h3 class="font-bold text-xl text-gray-800 dark:text-white lang-summary">Order Summary</h3>
                        </div>
                        
                        <div class="mb-6 bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-semibold text-gray-700 dark:text-gray-300">Deliver To:</h4>
                                <button onclick="openAddressModal()" class="text-sm text-green-600 dark:text-green-400 font-medium hover:underline flex items-center gap-1">
                                    <i data-lucide="plus" class="w-3 h-3"></i> Add New
                                </button>
                            </div>
                            <div id="summary-address-list" class="space-y-2"></div>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-3">Product Details</h4>
                            <div id="summary-items" class="space-y-4"></div>
                        </div>
                        
                        <div class="border-t dark:border-gray-700 pt-4 space-y-2 text-sm text-gray-600 dark:text-gray-400">
                            <div class="flex justify-between">
                                <span>Item Total</span>
                                <span id="summary-subtotal" class="font-medium text-gray-800 dark:text-gray-200">‚Çπ0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Delivery Fee</span>
                                <span class="text-green-600 dark:text-green-400">Free</span>
                            </div>
                            <div class="flex justify-between text-lg font-bold text-gray-800 dark:text-white pt-2 border-t dark:border-gray-700 mt-2">
                                <span>Grand Total</span>
                                <span id="summary-total">‚Çπ0</span>
                            </div>
                        </div>
                        
                        <button onclick="proceedToPayment()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold text-lg hover:bg-green-700 shadow-lg mt-6 transition lang-pay-btn">Continue to Payment</button>
                    </div>
                </div>

                <div id="view-orders" class="hidden space-y-6">
  <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-4 md:p-6 transition-colors">
    <div class="flex items-center justify-between mb-6">
      <h3 class="font-bold text-lg text-gray-800 dark:text-white lang-orders">
        Order History
      </h3>

      <div class="relative">
        <button id="order-filter-toggle"
                class="flex items-center gap-2 px-3 py-1.5 border border-gray-200 dark:border-gray-600 
                       rounded-lg text-sm text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800
                       hover:bg-gray-50 dark:hover:bg-gray-700">
          <span id="order-filter-label">All Orders</span>
          <i data-lucide="chevron-down" class="w-4 h-4"></i>
        </button>

        <div id="order-filter-menu"
             class="absolute right-0 mt-2 w-44 bg-white dark:bg-gray-800 border border-gray-200
                    dark:border-gray-700 rounded-lg shadow-lg text-sm py-1 hidden z-50">
          <button onclick="setOrderFilter('all')"
                  class="w-full text-left px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700">
            All Orders
          </button>
          <button onclick="setOrderFilter('active')"
                  class="w-full text-left px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700">
            Active Orders
          </button>
          <button onclick="setOrderFilter('cancelled')"
                  class="w-full text-left px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700">
            Cancelled Orders
          </button>
          <button onclick="setOrderFilter('delivered')"
                  class="w-full text-left px-3 py-1.5 hover:bg-gray-100 dark:hover:bg-gray-700">
            Delivered Orders
          </button>
        </div>
      </div>
    </div>

    <div class="space-y-4" id="orders-list-full"></div>
  </div>
</div>

                <div id="view-wishlist" class="hidden space-y-6">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xl text-gray-800 dark:text-white lang-wishlist">My Wishlist</h3>
                     </div>
                     <div id="wishlist-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>

                <div id="view-addresses" class="hidden space-y-6">
                    <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm transition-colors">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-white lang-addresses">Saved Addresses</h3>
                            <button onclick="openAddressModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-green-700 transition">
                                <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i> Add New
                            </button>
                        </div>
                        <div id="addresses-container" class="space-y-4"></div>
                    </div>
                </div>

                <div id="view-about" class="hidden space-y-6 pb-12">
    <!-- Hero Section -->
    
    <!-- Hero Section with Brand Logo -->
    <div class="bg-gradient-to-br from-emerald-600 to-green-800 p-6 md:p-10 rounded-3xl shadow-xl relative overflow-hidden flex flex-col md:flex-row items-center gap-6 text-center md:text-left">
        <!-- Brand Logo Image -->
        <div class="w-32 h-32 md:w-40 md:h-40 bg-white rounded-full p-1 shadow-2xl flex-shrink-0 relative z-10">
            <img src="IMG_20251229_120150.jpg" alt="G.O.A.T Logo" class="w-full h-full object-contain rounded-full">
        </div>

        <div class="relative z-10 flex-1">
            <div class="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-1 rounded-full text-white text-xs font-bold mb-4 border border-white/30">
                <i data-lucide="calendar" class="w-3 h-3"></i> ESTD. 1987
            </div>
            <h2 class="text-3xl md:text-5xl font-extrabold text-white mb-2 tracking-tight uppercase">Livestock Sheep & Goats</h2>
            <p class="text-emerald-50 font-medium text-sm md:text-lg opacity-90 max-w-xl">
                G.O.A.T (Greatest Of All Time) ‚Äî India's Premier Import & Export Livestock Enterprise.
            </p>
        </div>

        <!-- Decorative background icon -->
        <div class="absolute -right-10 -bottom-10 opacity-10">
            <i data-lucide="award" class="w-48 h-48 text-white"></i>
        </div>
    </div>

    <!-- Moving Media Banner -->
    <div class="space-y-3">
        <div class="flex items-center justify-between px-1 md:px-2">
            <h3 class="text-xs md:text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">Our Gallery & Offers</h3>
            <span class="text-[10px] md:text-xs text-emerald-600 dark:text-emerald-400 font-medium">Auto-scrolling Gallery</span>
        </div>

        <div class="lm-marquee-container py-4 rounded-2xl overflow-hidden">
            <div class="lm-marquee-track px-4">
                <!-- Image Cards with Blur Fill -->
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0006.jpg')"><img src="IMG-20251225-WA0006.jpg" alt="Business Card" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG_20251229_120150.jpg')"><img src="IMG_20251229_120150.jpg" alt="Livestock Branding" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0014.jpg')"><img src="IMG-20251225-WA0014.jpg" alt="Mega Sale Poster" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0013.jpg')"><img src="IMG-20251225-WA0013.jpg" alt="Sale Offer" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0007.jpg')"><img src="IMG-20251225-WA0007.jpg" alt="Premium Sheep" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG_20251228_224143.jpg')"><img src="IMG_20251228_224143.jpg" alt="Farm Yard" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG_20251228_224222.jpg')"><img src="IMG_20251228_224222.jpg" alt="Goat Farm" loading="lazy"></div>

                <!-- Video Card (Blur omitted for video due to CSS limitations, simple background used) -->
                <div class="lm-media-card" style="background: #000;">
                    <video src="VID-20251225-WA0023.mp4" autoplay muted loop playsinline></video>
                </div>

                <!-- Duplicated for Seamless Loop -->
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0006.jpg')"><img src="IMG-20251225-WA0006.jpg" alt="Business Card" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG_20251229_120150.jpg')"><img src="IMG_20251229_120150.jpg" alt="Livestock Branding" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0014.jpg')"><img src="IMG-20251225-WA0014.jpg" alt="Mega Sale Poster" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0013.jpg')"><img src="IMG-20251225-WA0013.jpg" alt="Sale Offer" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG-20251225-WA0007.jpg')"><img src="IMG-20251225-WA0007.jpg" alt="Premium Sheep" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG_20251228_224143.jpg')"><img src="IMG_20251228_224143.jpg" alt="Farm Yard" loading="lazy"></div>
                <div class="lm-media-card" style="--bg-img: url('IMG_20251228_224222.jpg')"><img src="IMG_20251228_224222.jpg" alt="Goat Farm" loading="lazy"></div>
                <div class="lm-media-card" style="background: #000;">
                    <video src="VID-20251225-WA0023.mp4" autoplay muted loop playsinline></video>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-lg">
                    <i data-lucide="history" class="w-5 h-5 text-emerald-600"></i>
                </div>
                <h3 class="font-bold text-gray-800 dark:text-white">Our Legacy</h3>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
                Founded by <strong>Kambala Kondayya Garu</strong>, we have been serving the livestock community for over three decades. Sourcing the finest breeds from Guntur, Nalgonda, Miryalaguda, and Macharla.
            </p>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm">
            <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg">
                    <i data-lucide="globe" class="w-5 h-5 text-blue-600"></i>
                </div>
                <h3 class="font-bold text-gray-800 dark:text-white">Import & Export</h3>
            </div>
            <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-2">
                <li class="flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i> Direct farm sourcing and doorstep delivery.</li>
                <li class="flex items-center gap-2"><i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i> Verified quality for local and export markets.</li>
            </ul>
        </div>
    </div>

    <!-- Contact & Location -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm">
        <h3 class="font-bold text-gray-800 dark:text-white mb-6 flex items-center gap-2">
            <i data-lucide="map-pin" class="w-5 h-5 text-red-500"></i> Visit Our Headquarters
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-4">
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">Address</p>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        Door No: 3-73/1, Near Z.P. High School,<br>
                        K. Pentapadu, West Godavari District,<br>
                        Andhra Pradesh - 534166.
                    </p>
                </div>
                <div class="flex flex-wrap gap-3">
                        <a href="https://whatsapp.com/channel/0029VaD8mYTAInPij7sCeR2K" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 rounded-xl text-sm font-semibold hover:bg-green-100 transition">
                            <i data-lucide="message-circle" class="w-4 h-4"></i> WhatsApp
                        </a>
                        <a href="https://www.youtube.com/@livestocksheepsandgoatssel110" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-xl text-sm font-semibold hover:bg-red-100 transition">
                            <i data-lucide="youtube" class="w-4 h-4"></i> YouTube
                        </a>
                        <a href="https://www.instagram.com/livestocksheepsandgoats?igsh=aGhxcHJ4MDFzdm12" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-pink-50 dark:bg-pink-900/20 text-pink-700 dark:text-pink-400 rounded-xl text-sm font-semibold hover:bg-pink-100 transition">
                            <i data-lucide="instagram" class="w-4 h-4"></i> Instagram
                        </a>
                    </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-900/50 p-4 rounded-xl border border-dashed border-gray-200 dark:border-gray-700">
                <p class="text-xs font-bold text-gray-400 uppercase mb-3">Key Contacts</p>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium dark:text-gray-200">K. Surya Chandra Rao</span>
                        <span class="text-sm text-emerald-600 font-bold tracking-tight">9000274439</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium dark:text-gray-200">k. Srinivasa Rao</span>
                        <span class="text-sm text-emerald-600 font-bold tracking-tight">9908817975</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

                <div id="view-profile" class="hidden space-y-6">
                    <div class="bg-white dark:bg-gray-800 p-4 md:p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm transition-colors">
                        <h3 class="font-bold text-lg mb-4 text-gray-800 dark:text-white">Profile Settings</h3>
                        <div class="space-y-4 max-w-md">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Full Name</label>
                                <input id="profile-name-input" type="text" value="" disabled
                                       class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 cursor-not-allowed">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                                <input id="profile-email-input" type="email" value="" class="mt-1 block w-full border border-gray-300 dark:border-gray-600 rounded-md shadow-sm p-2 bg-white dark:bg-gray-700 dark:text-white" disabled>
                            </div>
                            
                            <div class="pt-4 mt-4 border-t border-gray-100 dark:border-gray-700">
                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
                                    <div class="flex items-center gap-3">
                                        <div class="p-2 bg-white dark:bg-gray-600 rounded-full shadow-sm">
                                            <i data-lucide="moon" class="w-5 h-5 text-gray-600 dark:text-gray-200"></i>
                                        </div>
                                        <div>
                                            <p class="font-semibold text-gray-800 dark:text-gray-100">Dark Mode</p>
                                            <p class="text-xs text-gray-500 dark:text-gray-400">Adjust appearance</p>
                                        </div>
                                    </div>
                                    <button onclick="toggleDarkMode()" class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 bg-gray-200 dark:bg-green-600" id="dark-mode-toggle">
                                        <span class="translate-x-1 inline-block h-4 w-4 transform rounded-full bg-white transition-transform dark:translate-x-6"></span>
                                    </button>
                                </div>
                            </div>

                            <p class="text-xs text-gray-400">Profile is based on your login data.</p>
                        </div>
                    </div>
                </div>

                <div id="view-support" class="hidden space-y-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm text-center py-12 transition-colors">
                        <i data-lucide="headphones" class="w-12 h-12 mx-auto text-green-600 mb-4"></i>
                        <h3 class="font-bold text-lg text-gray-800 dark:text-white">Need Help?</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Contact our support team 24/7</p>
                        <button class="bg-green-600 text-white px-6 py-2 rounded-full">Start Chat</button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const API_URL = 'https://goat-user-latest.vercel.app/api';
        let livestock = [];
        let orders = [];
        let cart = []; 
        let wishlist = []; 
        let addresses = [];
        let notifications = [];
        let currentCategory = 'All';
        let currentUser = null;
        let appInitialized = false;
        let currentAddress = null;
        let pendingCheckoutItems = null;
        let editingAddressIndex = -1;
        let autoRefreshInterval = null; 
        let proofUploaded = false; 
        let isSavingState = false;
let currentOrderFilter = 'all';
let isConfirmingPayment = false;

// --- Session auto-logout (30 minutes) ---
const SESSION_TIMEOUT_MS = 30 * 60 * 1000;
let sessionTimer = null;

function resetSessionTimer() {
  if (!currentUser) return;
  if (sessionTimer) clearTimeout(sessionTimer);
  sessionTimer = setTimeout(() => {
    showToast('Session expired. Please login again.', 'info');
    handleLogout();
  }, SESSION_TIMEOUT_MS);
}

['click', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach((evt) => {
  document.addEventListener(
    evt,
    () => {
      if (currentUser) resetSessionTimer();
    },
    { passive: true }
  );
});
; // Fix: Flag to prevent race conditions during sync
        
        // --- Language & Notifications ---
        let currentLang = localStorage.getItem('lm_lang') || 'en';
        const notifSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');

        const translations = {
            en: {
                dashboard: "My Dashboard", browse: "Browse Livestock", cart: "Shopping Cart", orders: "Order History",
                wishlist: "Wishlist", addresses: "Addresses", support: "Support", about: "About",
                checkout: "Proceed to Checkout", summary: "Order Summary", pay_btn: "Continue to Payment", reupload: "Re-upload Proof",
                goat: "Goat", sheep: "Sheep", breed: "Breed", weight: "Weight", buy: "Buy Now", add_cart: "Add to Cart", sold: "Sold Out",
                about_title: "About LivestockMart", about_desc: "India's most trusted digital marketplace for high-quality goats and sheep. We connect breeders directly with buyers, ensuring transparency, fair pricing, and healthy livestock delivery.",
                recent_orders: "Recent Orders"
            },
            te: {
                dashboard: "‡∞®‡∞æ ‡∞°‡∞æ‡∞∑‡±ç‚Äå‡∞¨‡±ã‡∞∞‡±ç‡∞°‡±ç", browse: "‡∞™‡∞∂‡±Å‡∞µ‡±Å‡∞≤‡∞®‡±Å ‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø", cart: "‡∞∑‡∞æ‡∞™‡∞ø‡∞Ç‡∞ó‡±ç ‡∞ï‡∞æ‡∞∞‡±ç‡∞ü‡±ç", orders: "‡∞®‡∞æ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å",
                wishlist: "‡∞ï‡±ã‡∞∞‡∞ø‡∞ï‡∞≤ ‡∞ú‡∞æ‡∞¨‡∞ø‡∞§‡∞æ", addresses: "‡∞ö‡∞ø‡∞∞‡±Å‡∞®‡∞æ‡∞Æ‡∞æ‡∞≤‡±Å", support: "‡∞Æ‡∞¶‡±ç‡∞¶‡∞§‡±Å", about: "‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø",
                checkout: "‡∞ö‡±Ü‡∞ï‡±ç‚Äå‡∞Ö‡∞µ‡±Å‡∞ü‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø", summary: "‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞µ‡∞ø‡∞µ‡∞∞‡∞æ‡∞≤‡±Å", pay_btn: "‡∞ö‡±Ü‡∞≤‡±ç‡∞≤‡∞ø‡∞Ç‡∞™‡±Å ‡∞ï‡±ä‡∞®‡∞∏‡∞æ‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø", reupload: "‡∞Æ‡∞≥‡±ç‡∞≤‡±Ä ‡∞™‡±ç‡∞∞‡±Ç‡∞´‡±ç ‡∞Ö‡∞™‡±ç‚Äå‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
                goat: "‡∞Æ‡±á‡∞ï", sheep: "‡∞ó‡±ä‡∞∞‡±ç‡∞∞‡±Ü", breed: "‡∞ú‡∞æ‡∞§‡∞ø", weight: "‡∞¨‡∞∞‡±Å‡∞µ‡±Å", buy: "‡∞µ‡±Ü‡∞Ç‡∞ü‡∞®‡±á ‡∞ï‡±ä‡∞®‡∞Ç‡∞°‡∞ø", add_cart: "‡∞ï‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞≤‡±ã ‡∞ö‡±á‡∞∞‡±ç‡∞ö‡∞Ç‡∞°‡∞ø", sold: "‡∞Ö‡∞Æ‡±ç‡∞Æ‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø",
                about_title: "‡∞≤‡±à‡∞µ‡±ç‚Äå‡∞∏‡±ç‡∞ü‡∞æ‡∞ï‡±ç ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø", about_desc: "‡∞®‡∞Æ‡±ç‡∞Æ‡∞ï‡∞Ç‡∞§‡±ã ‡∞™‡±Ü‡∞Ç‡∞™‡∞ï‡∞Ç‡∞¶‡∞æ‡∞∞‡±Å‡∞≤‡∞®‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞ï‡±ä‡∞®‡±Å‡∞ó‡±ã‡∞≤‡±Å‡∞¶‡∞æ‡∞∞‡±Å‡∞≤‡∞®‡±Å ‡∞ï‡∞≤‡∞ø‡∞™‡±á ‡∞≠‡∞æ‡∞∞‡∞§‡∞¶‡±á‡∞∂‡∞™‡±Å ‡∞™‡±ç‡∞∞‡∞Æ‡±Å‡∞ñ ‡∞°‡∞ø‡∞ú‡∞ø‡∞ü‡∞≤‡±ç ‡∞™‡∞∂‡±Å‡∞µ‡±Å‡∞≤ ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡±Ü‡∞ü‡±ç. ‡∞Æ‡±á‡∞Æ‡±Å ‡∞®‡∞æ‡∞£‡±ç‡∞Ø‡∞Æ‡±à‡∞® ‡∞™‡∞∂‡±Å‡∞µ‡±Å‡∞≤‡∞®‡±Å ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡±Å‡∞∞‡∞ï‡±ç‡∞∑‡∞ø‡∞§‡∞Æ‡±à‡∞® ‡∞°‡±Ü‡∞≤‡∞ø‡∞µ‡∞∞‡±Ä‡∞®‡∞ø ‡∞Ö‡∞Ç‡∞¶‡∞ø‡∞∏‡±ç‡∞§‡∞æ‡∞Æ‡±Å.",
                recent_orders: "‡∞á‡∞ü‡±Ä‡∞µ‡∞≤‡∞ø ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡±Å"
            }
        };

        function changeLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lm_lang', lang);
            document.getElementById('lang-menu').classList.add('hidden');
            applyTranslations();
            // Re-render views that have translated content
            if(!document.getElementById('view-browse').classList.contains('hidden')) renderBrowse();
            if(!document.getElementById('view-orders').classList.contains('hidden')) renderOrders();
            if(!document.getElementById('view-about').classList.contains('hidden')) document.getElementById('view-about').classList.remove('hidden'); // Refresh text
            showToast(lang === 'te' ? '‡∞≠‡∞æ‡∞∑ ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø' : 'Language changed', 'success');
        }

        function applyTranslations() {
            const t = translations[currentLang];
            document.querySelectorAll('.lang-dashboard').forEach(e => e.innerText = t.dashboard);
            document.querySelectorAll('.lang-browse').forEach(e => e.innerText = t.browse);
            document.querySelectorAll('.lang-cart').forEach(e => e.innerText = t.cart);
            document.querySelectorAll('.lang-orders').forEach(e => e.innerText = t.orders);
            document.querySelectorAll('.lang-wishlist').forEach(e => e.innerText = t.wishlist);
            document.querySelectorAll('.lang-addresses').forEach(e => e.innerText = t.addresses);
            document.querySelectorAll('.lang-support').forEach(e => e.innerText = t.support);
            document.querySelectorAll('.lang-about').forEach(e => e.innerText = t.about);
            document.querySelectorAll('.lang-checkout').forEach(e => e.innerText = t.checkout);
            document.querySelectorAll('.lang-summary').forEach(e => e.innerText = t.summary);
            document.querySelectorAll('.lang-pay-btn').forEach(e => e.innerText = t.pay_btn);
            document.querySelectorAll('.lang-about-title').forEach(e => e.innerText = t.about_title);
            document.querySelectorAll('.lang-about-desc').forEach(e => e.innerText = t.about_desc);
            document.querySelectorAll('.lang-recent-orders').forEach(e => e.innerText = t.recent_orders);
            
            // Update page title based on active view
            const activeNav = document.querySelector('.nav-item.bg-green-600');
            if(activeNav) {
                const viewKey = activeNav.getAttribute('onclick').match(/'([^']+)'/)[1];
                document.getElementById('page-title').innerText = t[viewKey] || (viewKey.charAt(0).toUpperCase() + viewKey.slice(1));
            }
        }

        // --- Theme & Layout ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            updateToggleUI();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            updateToggleUI();
            
            // Re-render active view to update dynamic classes
            const activeNav = document.querySelector('.nav-item.bg-green-600');
            if (activeNav) {
                const onclick = activeNav.getAttribute('onclick') || "";
                const currentView = onclick.replace("router('", "").replace("')", "") || 'dashboard';
                router(currentView); // Simple re-render
            }
        }
        
        function updateToggleUI() {
            const btn = document.getElementById('dark-mode-toggle');
            if(!btn) return;
            const isDark = document.documentElement.classList.contains('dark');
            if(isDark){
                btn.className = "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 bg-green-600";
                btn.firstElementChild.className = "translate-x-6 inline-block h-4 w-4 transform rounded-full bg-white transition-transform";
            } else {
                btn.className = "relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 bg-gray-200";
                btn.firstElementChild.className = "translate-x-1 inline-block h-4 w-4 transform rounded-full bg-white transition-transform";
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        
        let previousLivestockCount = parseInt(localStorage.getItem('lm_prev_ls_count') || '0');
        let previousOrdersSnapshot = localStorage.getItem('lm_prev_orders_snap') || '[]';
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const id = 'toast-' + Date.now();
            const baseClasses = 'pointer-events-auto max-w-xs w-full rounded-xl shadow-lg px-4 py-3 text-sm flex items-start gap-3 transform transition-all duration-200';
            const types = {
                success: 'bg-emerald-600 text-white',
                error: 'bg-red-600 text-white',
                warning: 'bg-yellow-500 text-black',
                info: 'bg-gray-800 text-white dark:bg-gray-700'
            };
            const icon = {
                success: 'check-circle',
                error: 'alert-triangle',
                warning: 'alert-circle',
                info: 'info'
            }[type] || 'info';
            const div = document.createElement('div');
            div.id = id;
            div.className = baseClasses + ' ' + (types[type] || types.info);
            div.innerHTML = `
                <div class="mt-0.5">
                    <i data-lucide="${icon}" class="w-4 h-4"></i>
                </div>
                <div class="flex-1">${message}</div>
                <button onclick="document.getElementById('${id}')?.remove()" class="ml-2 text-xs opacity-80 hover:opacity-100">‚úï</button>
            `;
            container.appendChild(div);
            lucide.createIcons();
            setTimeout(() => {
                div.classList.add('opacity-0', 'translate-x-2');
                setTimeout(() => div.remove(), 150);
            }, 3000);
        }

        function formatINR(value) {
            const num = Number(value) || 0;
            return num.toLocaleString('en-IN');
        }

        function getVisibleWishlistCount() {
            return wishlist.filter(id => livestock.some(item => item._id === id)).length;
        }
        
        async function saveNotifications() { await saveUserState(); }

        async function markNotificationsAsSeen() {
            notifications.forEach(n => n.seen = true);
            await saveNotifications();
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const clearBtn = document.getElementById('clear-all-btn');
            if (!badge) return;
            const unseenCount = notifications.filter(n => !n.seen).length;
            badge.innerText = unseenCount;
            if (unseenCount > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            if (clearBtn) clearBtn.disabled = notifications.length === 0;
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            if (!list) return;
            if (notifications.length === 0) {
                list.innerHTML = `<p class="text-center text-xs text-gray-400 py-4" id="no-notifications-msg">No new notifications.</p>`;
            } else {
                list.innerHTML = [...notifications].reverse().map(n => {
                    const seenStyle = n.seen ? 'opacity-60' : 'bg-green-50/50 dark:bg-green-900/20';
                    return `
                    <div class="flex items-start justify-between p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150 ${seenStyle}">
                        <div class="flex items-start gap-2 flex-1">
                            <i data-lucide="${n.icon}" class="w-4 h-4 mt-0.5 text-${n.color}-500 flex-shrink-0"></i>
                            <div>
                                <p class="text-xs font-medium text-gray-800 dark:text-gray-200">${n.title}</p>
                                <p class="text-[11px] text-gray-500 dark:text-gray-400">${n.message}</p>
                            </div>
                        </div>
                        <button onclick="removeNotification('${n.id}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 ml-2 p-1 -mt-1"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                `}).join('');
            }
            updateNotificationBadge();
            lucide.createIcons();
        }

        function toggleNotificationMenu(force) {
            const menu = document.getElementById('notification-menu');
            if (!menu) return;
            const isHidden = menu.classList.contains('hidden');
            if (typeof force === 'boolean') {
                if (force) {
                    renderNotifications();
                    menu.classList.remove('hidden', 'scale-95', 'opacity-0');
                    menu.classList.add('scale-100', 'opacity-100');
                } else {
                    markNotificationsAsSeen();
                    menu.classList.remove('scale-100', 'opacity-100');
                    menu.classList.add('scale-95', 'opacity-0');
                    setTimeout(() => menu.classList.add('hidden'), 300); 
                }
                return;
            }
            if (isHidden) {
                renderNotifications();
                menu.classList.remove('hidden', 'scale-95', 'opacity-0');
                menu.classList.add('scale-100', 'opacity-100');
            } else {
                markNotificationsAsSeen();
                menu.classList.remove('scale-100', 'opacity-100');
                menu.classList.add('scale-95', 'opacity-0');
                setTimeout(() => menu.classList.add('hidden'), 300); 
            }
        }

        async function removeNotification(id) { 
            notifications = notifications.filter(n => n.id !== id);
            await saveNotifications();
            renderNotifications();
        }

        async function clearAllNotifications() {
            notifications = [];
            await saveNotifications();
            renderNotifications();
            showToast('All notifications cleared.', 'info');
        }

        async function loadUserState() {
            if (!currentUser || !currentUser.id) return;
            try {
                const response = await fetch(`${API_URL}/user/state?_=${Date.now()}`, { method: 'GET', credentials: 'include' });
                if (response.ok) {
                    const data = await response.json(); 
                    cart = data.cart || [];
                    wishlist = data.wishlist || []; 
                    addresses = data.addresses || [];
                    notifications = data.notifications || []; 
                    if (addresses.length > 0 && !currentAddress) currentAddress = addresses[0];
                } else {
                    cart = []; wishlist = []; addresses = []; notifications = []; currentAddress = null;
                }
            } catch (e) { console.error('Error loading user state:', e); }
        }
        
        async function saveUserState() {
            if (!currentUser || !currentUser.id) return;
            
            isSavingState = true; // Fix: LOCK state
            
            try {
                await fetch(`${API_URL}/user/state`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ cart, wishlist, addresses, notifications }) 
                });
            } catch (e) { console.error('Error saving user state:', e); }
            finally { setTimeout(() => { isSavingState = false; }, 500); } // Fix: UNLOCK state
        }

        function switchAuthView(mode) {
            const card = document.getElementById('auth-card');
            if (!card) return;
            if (mode === 'register') {
                card.classList.add('show-register');
                document.querySelector('.auth-panel-register').style.position = 'relative';
                document.querySelector('.auth-panel-login').style.position = 'absolute';
            } else {
                card.classList.remove('show-register');
                document.querySelector('.auth-panel-register').style.position = 'absolute';
                document.querySelector('.auth-panel-login').style.position = 'relative';
            }
        }
        function showAuthError(message) {
            const el = document.getElementById('auth-error');
            if (!el) return;
            if (message) {
                el.textContent = message;
                el.classList.remove('hidden');
                showToast(message, 'error');
            } else {
                el.textContent = '';
                el.classList.add('hidden');
            }
        }
        function showAuthScreen() {
            const auth = document.getElementById('auth-screen');
            const app = document.getElementById('user-app');
            if (auth) auth.classList.remove('hidden');
            if (app) app.classList.add('hidden');
        }
        function showApp() {
            const auth = document.getElementById('auth-screen');
            const app = document.getElementById('user-app');
            if (auth) auth.classList.add('hidden');
            if (app) app.classList.remove('hidden');
            if (!appInitialized) {
                initApp();
            }
        }
        function getInitials(name) {
            if (!name) return 'U';
            return name.split(' ').filter(Boolean).map(n => n[0].toUpperCase()).join('').slice(0, 2);
        }
        function updateProfileUI() {
            const avatar = document.getElementById('profile-avatar');
            const nameEl = document.getElementById('profile-name');
            const metaEl = document.getElementById('profile-meta');
            const profileNameInput = document.getElementById('profile-name-input');
            const profileEmailInput = document.getElementById('profile-email-input');
            const name = currentUser?.name || 'User';
            const email = currentUser?.email || '';
            if (avatar) avatar.textContent = getInitials(name);
            if (nameEl) nameEl.textContent = name;
            if (metaEl) metaEl.textContent = 'Welcome back';
            if (profileNameInput) profileNameInput.value = name;
            if (profileEmailInput) profileEmailInput.value = email;
        }
        function toggleProfileMenu(force) {
            const menu = document.getElementById('profile-menu');
            if (!menu) return;
            if (typeof force === 'boolean') {
                if (force) menu.classList.remove('hidden');
                else menu.classList.add('hidden');
                return;
            }
            menu.classList.toggle('hidden');
        }
        async function handleLogin(event) {
            event.preventDefault();
            showAuthError('');
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            if (!email || !password) return showAuthError('Please enter email and password.');
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!res.ok) return showAuthError(data.message || 'Login failed.');
                
                currentUser = data.user;
                await loadUserState();
                updateProfileUI();
                updateCartBadge();
                updateWishlistBadge(); 
                updateNotificationBadge(); 
                showToast('Logged in successfully', 'success');
                showApp()
  resetSessionTimer();
;
            } catch (err) {
                console.error('Login error', err);
                showAuthError('Something went wrong. Please try again.');
            }
        }
        async function handleRegister(event) {
            event.preventDefault();
            showAuthError('');
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            if (!name || !email || !password) return showAuthError('All fields are required.');
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ name, email, password })
                });
                const data = await res.json();
                if (!res.ok) return showAuthError(data.message || 'Registration failed.');
                
                currentUser = data.user;
                await loadUserState();
                updateProfileUI();
                updateCartBadge();
                updateWishlistBadge(); 
                updateNotificationBadge(); 
                showToast('Account created & logged in', 'success');
                showApp()
  resetSessionTimer();
;
            } catch (err) {
                console.error('Register error', err);
                showAuthError('Something went wrong. Please try again.');
            }
        }
        async function handleLogout() {
  if (sessionTimer) clearTimeout(sessionTimer);
  sessionTimer = null;

            try { await fetch(`${API_URL}/auth/logout`, { method: 'POST', credentials: 'include' }); } catch (err) {}
            currentUser = null; cart = []; wishlist = []; addresses = []; currentAddress = null; notifications = [];
            ['login-email', 'login-password', 'register-name', 'register-email', 'register-password'].forEach(id => {
                const el = document.getElementById(id); if(el) el.value = '';
            });
            localStorage.removeItem('lm_prev_ls_count');
            localStorage.removeItem('lm_prev_orders_snap');
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); toggleProfileMenu(false);
            showToast('Logged out', 'info');
            switchAuthView('login'); 
            showAuthScreen();
        }
        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me?_=${Date.now()}`, { method: 'GET', credentials: 'include' });
                if (res.ok) {
                    const data = await res.json();
                    currentUser = data.user;
                    await loadUserState(); 
                    updateProfileUI();
                    showApp()
    resetSessionTimer();
;
                } else showAuthScreen();
            } catch (err) { showAuthScreen(); }
        }
        async function loadData() {
            if (currentUser && !isSavingState) await loadUserState(); // Fix: Only load if not saving

            let fetchedOrders = orders;
            let fetchedLivestock = livestock;
            const isBaselineInitialized = previousLivestockCount > 0 || JSON.parse(previousOrdersSnapshot).length > 0;
            
            try {
                const lsRes = await fetch(`${API_URL}/livestock?_=${Date.now()}`);
                fetchedLivestock = await lsRes.json();
                fetchedLivestock.sort((a, b) => (a._id < b._id) ? 1 : -1);
                
                try {
                     const notifRes = await fetch(`${API_URL}/notifications?_=${Date.now()}`);
                     if (notifRes.ok) {
                         const fetchedNotifs = await notifRes.json();
                         let newNotifFound = false;
                         fetchedNotifs.forEach(fn => {
                             if(!notifications.some(n => n.id === fn.id)) {
                                 notifications.push(fn);
                                 newNotifFound = true;
                             }
                         });
                         if(newNotifFound) {
                             notifSound.play().catch(()=>{});
                             const last = notifications[notifications.length-1];
                             showToast(last.message, last.color === 'red' ? 'error' : 'info');
                         }
                     }
                } catch(e) { }

                if (isBaselineInitialized && fetchedLivestock.length > previousLivestockCount) {
                    const newCount = fetchedLivestock.length - previousLivestockCount;
                    notifications.push({
                        id: 'ls_' + Date.now() + Math.random(),
                        title: 'Market Update',
                        message: `${newCount} new livestock item${newCount > 1 ? 's' : ''} added to the market!`,
                        icon: 'sheep',
                        color: 'green',
                        timestamp: Date.now(),
                        seen: false
                    });
                }
                
                if (currentUser) {
                    const ordRes = await fetch(`${API_URL}/orders?_=${Date.now()}`, { method: 'GET', credentials: 'include' });
                    fetchedOrders = await ordRes.json();
                    fetchedOrders.sort((a,b) => (a._id < b._id) ? 1 : -1); 

                    const previousOrderMap = JSON.parse(previousOrdersSnapshot).reduce((acc, o) => { acc[o._id] = o.status; return acc; }, {});

                    if (isBaselineInitialized) {
                        fetchedOrders.forEach(newOrder => {
                            const oldStatus = previousOrderMap[newOrder._id];
                            if (oldStatus && oldStatus !== newOrder.status) {
                                notifications.push({
                                    id: 'order_' + newOrder._id + Date.now(),
                                    title: 'Order Status Update',
                                    message: `Order #${String(newOrder._id).slice(-6)} status changed to ${newOrder.status}.`,
                                    icon: 'package',
                                    color: newOrder.status === 'Delivered' ? 'gray' : 'blue',
                                    timestamp: Date.now(),
                                    seen: false
                                });
                            }
                        });
                    }
                }
            } catch (e) { console.error("API Error during loadData", e); }
            
            const livestockChanged = JSON.stringify(livestock) !== JSON.stringify(fetchedLivestock);
            const ordersChanged = JSON.stringify(orders) !== JSON.stringify(fetchedOrders);
            const notificationsChanged = notifications.length > 0 && isBaselineInitialized;

            if(livestockChanged) livestock = fetchedLivestock;
            if(ordersChanged) orders = fetchedOrders;
            
            previousLivestockCount = livestock.length;
            localStorage.setItem('lm_prev_ls_count', livestock.length);

            previousOrdersSnapshot = JSON.stringify(orders.map(o => ({ _id: o._id, status: o.status })));
            localStorage.setItem('lm_prev_orders_snap', previousOrdersSnapshot);
            
            if (notificationsChanged) await saveNotifications();

            const validLivestockIds = livestock.map(item => item._id);
            const cleanedWishlist = wishlist.filter(id => validLivestockIds.includes(id));
            if (cleanedWishlist.length !== wishlist.length) {
                wishlist = cleanedWishlist;
                await saveUserState();
            }
            
            const activeNav = document.querySelector('.nav-item.bg-green-600');
            let currentView = 'dashboard';
            if (activeNav) {
                const onclick = activeNav.getAttribute('onclick') || "";
                currentView = onclick.replace("router('", "").replace("')", "") || 'dashboard';
            } else if (!document.getElementById('view-summary').classList.contains('hidden')) {
                currentView = 'summary';
            }
            
            if (currentView === 'browse' && livestockChanged) renderBrowse(); 
            if (currentView === 'orders' && ordersChanged) renderOrders();
            if (currentView === 'dashboard' && (livestockChanged || ordersChanged)) renderDashboard(); 
            if (currentView === 'cart') renderCart(); 
            if (currentView === 'wishlist') renderWishlist();
            if (currentView === 'addresses') renderAddresses();
            if (currentView === 'summary') renderSummary();

            updateCartBadge();
            updateWishlistBadge(); 
            updateNotificationBadge(); 
        }

        function router(viewName) {
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            
            currentCategory = 'All';
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.innerText === 'All') {
                    btn.classList.add('bg-gray-800', 'text-white', 'hover:bg-gray-700', 'dark:bg-gray-700');
                    btn.classList.remove('bg-white', 'text-gray-600', 'border', 'hover:bg-gray-50', 'dark:bg-gray-800', 'dark:text-gray-300');
                } else {
                    btn.classList.remove('bg-gray-800', 'text-white', 'hover:bg-gray-700', 'dark:bg-gray-700');
                    btn.classList.add('bg-white', 'text-gray-600', 'border', 'hover:bg-gray-50', 'dark:bg-gray-800', 'dark:text-gray-300', 'dark:border-gray-700', 'dark:hover:bg-gray-700');
                }
            });

            loadData();
            
            // Handle view switching
            ['dashboard', 'browse', 'cart', 'orders', 'wishlist', 'addresses', 'profile', 'support', 'summary', 'about'].forEach(v => {
                document.getElementById(`view-${v}`)?.classList.add('hidden');
            });
            const activeView = document.getElementById(`view-${viewName}`);
            if (activeView) activeView.classList.remove('hidden');
            
            // Sidebar Active State
            document.querySelectorAll('.nav-item').forEach(btn => {
                if (viewName === 'summary') return; 
                if (btn.getAttribute('onclick').includes(viewName)) {
                    btn.classList.add('bg-green-600', 'text-white');
                    btn.classList.remove('text-gray-600', 'hover:bg-gray-100', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
                } else {
                    btn.classList.remove('bg-green-600', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-gray-100', 'dark:text-gray-300', 'dark:hover:bg-gray-700');
                }
            });

            applyTranslations(); // Update title and dynamic text

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (window.innerWidth < 768 && !sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
            
            if (viewName === 'dashboard') renderDashboard();
            if (viewName === 'browse') renderBrowse();
            if (viewName === 'cart') renderCart();
            if (viewName === 'orders') renderOrders();
            if (viewName === 'wishlist') renderWishlist();
            if (viewName === 'addresses') renderAddresses();
            
            updateCartBadge(); updateWishlistBadge(); updateNotificationBadge(); 
            lucide.createIcons();
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard() {
            const totalSpent = orders.reduce((sum, order) => sum + (order.total || 0), 0);
            document.getElementById('dash-total-spent').innerText = formatINR(totalSpent);
            document.getElementById('dash-total-orders').innerText = orders.length;
            document.getElementById('dash-total-wishlist').innerText = getVisibleWishlistCount(); 
            document.getElementById('dash-total-cart').innerText = cart.length; 
            document.getElementById('dash-total-livestock').innerText = livestock.length;
            const recentContainer = document.getElementById('dash-recent-orders');
            if (orders.length === 0) {
                recentContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">No orders yet.</p>';
            } else {
                const recent = orders.slice(0, 3);
                recentContainer.innerHTML = recent.map(o => `
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg gap-3 transition-colors">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white dark:bg-gray-600 rounded flex items-center justify-center text-2xl border border-gray-100 dark:border-gray-500">üì¶</div>
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-200">${o.items[0].name} ${o.items.length > 1 ? '+' + (o.items.length - 1) + ' more' : ''}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">#${String(o._id).slice(-6)} ‚Ä¢ ${o.date}</p>
                            </div>
                        </div>
                        <div class="text-left sm:text-right w-full sm:w-auto flex justify-between sm:block pl-[3.25rem] sm:pl-0">
                            <p class="font-bold text-gray-800 dark:text-white">${formatINR(o.total)}</p>
                            <span class="text-xs px-2 py-1 ${getStatusColor(o.status)} rounded-full font-medium inline-block mt-1">${o.status}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        function filterCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const onclickVal = btn.getAttribute('onclick');
                if (onclickVal.includes("'" + cat + "'") || (cat === 'All' && onclickVal.includes("'All'"))) {
                    btn.classList.add('bg-gray-800', 'text-white', 'hover:bg-gray-700', 'dark:bg-gray-700');
                    btn.classList.remove('bg-white', 'text-gray-600', 'border', 'hover:bg-gray-50', 'dark:bg-gray-800', 'dark:text-gray-300');
                } else {
                    btn.classList.remove('bg-gray-800', 'text-white', 'hover:bg-gray-700', 'dark:bg-gray-700');
                    btn.classList.add('bg-white', 'text-gray-600', 'border', 'hover:bg-gray-50', 'dark:bg-gray-800', 'dark:text-gray-300', 'dark:border-gray-700', 'dark:hover:bg-gray-700');
                }
            });
            renderBrowse();
        }
        function renderBrowse() {
            const searchInput = document.getElementById('search-input');
            if (!searchInput) return;
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            const grid = document.getElementById('livestock-grid');
            const t = translations[currentLang];
            
            const filtered = livestock.filter(item => {
                const name = (item.name || '').toLowerCase();
                const breed = (item.breed || '').toLowerCase();
                const matchSearch = name.includes(searchTerm) || breed.includes(searchTerm);
                
                const itemType = (item.type || '').toLowerCase();
                const selectedCat = currentCategory.toLowerCase();
                const matchCat = currentCategory === 'All' || itemType === selectedCat || itemType.startsWith(selectedCat); 
                return matchSearch && matchCat;
            });
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-10">No livestock found matching your criteria.</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(item => {
                const inWishlist = wishlist.includes(item._id);
                const imageCount = (item.images && item.images.length > 0) ? item.images.length : 1;
                const isSold = item.status === 'Sold';

                const buttons = isSold
                    ? `<button disabled class="w-full bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed px-3 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        <i data-lucide="slash" class="w-4 h-4"></i> ${t.sold}
                       </button>`
                    : `<div class="flex gap-2 w-full">
                            <button onclick="buyNow('${item._id}')" class="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 transition">${t.buy}</button>
                            <button onclick="addToCart('${item._id}')" class="flex-1 bg-gray-900 dark:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-800 dark:hover:bg-gray-500 transition">${t.add_cart}</button>
                       </div>`;

                const soldOverlay = isSold ?
                    `<div class="absolute inset-0 bg-black/50 z-10 flex items-center justify-center rounded-lg">
                        <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full transform -rotate-12 border-2 border-white shadow-lg">${t.sold}</span>
                     </div>` : '';

                // Generate image slider HTML
                let imagesHTML = '';
                if (imageCount > 1) {
                    const imagesArray = Array.from({length: imageCount}, (_, i) =>
                        `<img src="${API_URL}/livestock/image/${item._id}/${i}" alt="${item.name}" class="slider-image w-full h-full object-cover rounded-lg ${isSold ? 'grayscale opacity-75' : ''}" onerror="this.onerror=null; this.src='https://via.placeholder.com/160?text=No+Image';">`
                    ).join('');

                    const dotsHTML = Array.from({length: imageCount}, (_, i) =>
                        `<span class="slider-dot ${i === 0 ? 'active' : ''}" onclick="setSlide('${item._id}', ${i})"></span>`
                    ).join('');

                    imagesHTML = `
                        <div class="image-slider-container h-40 bg-gray-100 dark:bg-gray-700 rounded-lg relative overflow-hidden mb-4">
                            ${soldOverlay}
                            <div class="image-slider-track h-full" id="slider-${item._id}">
                                ${imagesArray}
                            </div>
                            ${imageCount > 1 ? `
                                <button class="slider-nav slider-nav-prev" onclick="prevSlide('${item._id}', ${imageCount})">‚Äπ</button>
                                <button class="slider-nav slider-nav-next" onclick="nextSlide('${item._id}', ${imageCount})">‚Ä∫</button>
                                <div class="slider-dots">${dotsHTML}</div>
                            ` : ''}
                            <button onclick="toggleWishlist('${item._id}')" class="absolute top-2 right-2 p-2 bg-white dark:bg-gray-800 rounded-full shadow-sm hover:text-red-500 ${inWishlist ? 'text-red-500' : 'text-gray-400 dark:text-gray-500'} z-20">
                                <i data-lucide="heart" class="w-4 h-4 ${inWishlist ? 'fill-current' : ''}"></i>
                            </button>
                        </div>
                    `;
                } else {
                    const imageUrl = `${API_URL}/livestock/image/${item._id}`;
                    imagesHTML = `
                        <div class="h-40 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center text-6xl mb-4 relative overflow-hidden">
                            ${soldOverlay}
                            <img src="${imageUrl}" alt="${item.name}" class="w-full h-full object-cover rounded-lg ${isSold ? 'grayscale opacity-75' : ''}" onerror="this.onerror=null; this.src='https://via.placeholder.com/160?text=No+Image';">
                            <button onclick="toggleWishlist('${item._id}')" class="absolute top-2 right-2 p-2 bg-white dark:bg-gray-800 rounded-full shadow-sm hover:text-red-500 ${inWishlist ? 'text-red-500' : 'text-gray-400 dark:text-gray-500'} z-20">
                                <i data-lucide="heart" class="w-4 h-4 ${inWishlist ? 'fill-current' : ''}"></i>
                            </button>
                        </div>
                    `;
                }

                return `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-shadow relative overflow-hidden">
                    ${imagesHTML}
                    <div class="flex justify-between items-start mb-2">
                        <div class="truncate pr-2 w-full">
                            <h3 class="font-bold text-lg text-gray-800 dark:text-white truncate">${item.name}</h3>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                ${item.type === 'Goat' ? t.goat : t.sheep} ‚Ä¢ ${t.breed}: ${item.breed}<br>
                                ${t.weight}: ${item.weight ? item.weight + ' kg' : 'N/A'}
                            </p>
                        </div>
                        <span class="bg-gray-800 dark:bg-gray-700 text-white text-xs px-2 py-1 rounded flex-shrink-0 ml-1">${item.tags?.[0] || 'Good'}</span>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-xl font-bold text-green-700 dark:text-green-400">${formatINR(item.price)}</span>
                    </div>
                    <div class="mt-3">
                        ${buttons}
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
            window.applyRevealAndPremium(); 
        }
        function renderCart() {
            const container = document.getElementById('cart-items-container');
            const totalEl = document.getElementById('cart-total');
            const titleEl = document.getElementById('cart-count-title');
            if (cart.length === 0) {
                container.innerHTML = '<div class="text-center py-10 text-gray-400 dark:text-gray-500">Your cart is empty.</div>';
                totalEl.innerText = '0';
                titleEl.innerText = '(0 items)';
                return;
            }
            let total = 0;
            const selectedItems = cart.filter(item => item.selected !== false);
            total = selectedItems.reduce((sum, item) => sum + (item.price || 0), 0);
            const t = translations[currentLang];
            
            container.innerHTML = cart.map((item, index) => {
                const isSelected = item.selected !== false;
                const imageUrl = `${API_URL}/livestock/image/${item._id}`;
                return `
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg gap-4 transition-colors">
                    <div class="flex items-center gap-4 w-full sm:w-auto">
                        <input type="checkbox" class="w-5 h-5 flex-shrink-0" ${isSelected ? 'checked' : ''} onchange="toggleCartSelection(${index}, this.checked)">
                        <div class="w-16 h-16 bg-white dark:bg-gray-600 rounded-lg flex items-center justify-center text-3xl border border-gray-200 dark:border-gray-500 flex-shrink-0 overflow-hidden">
                           <img src="${imageUrl}" alt="${item.name}" class="w-full h-full object-cover rounded-lg" onerror="this.onerror=null; this.src='https://via.placeholder.com/64?text=Item';">
                        </div>
                        <div class="overflow-hidden">
                            <h4 class="font-bold text-gray-800 dark:text-white truncate">${item.name}</h4>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <p>${item.type === 'Goat' ? t.goat : t.sheep} ‚Ä¢ ${t.breed}: ${item.breed}</p>
                                <p>${t.weight}: ${item.weight ? item.weight + ' kg' : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center justify-between w-full sm:w-auto sm:gap-6 pl-9 sm:pl-0">
                        <p class="font-bold text-lg text-green-700 dark:text-green-400">${formatINR(item.price)}</p>
                        <button onclick="removeFromCart(${index})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-2 rounded-full">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            totalEl.innerText = formatINR(total);
            titleEl.innerText = `(${cart.length} items)`;
            lucide.createIcons();
        }
        function renderOrders() {
  const container = document.getElementById('orders-list-full');
  if (!container) return;

  // Apply filter
  let visibleOrders = orders || [];

  if (currentOrderFilter === 'active') {
    visibleOrders = visibleOrders.filter(o =>
      !['Cancelled', 'Delivered', 'Payment Rejected'].includes(o.status)
    );
  } else if (currentOrderFilter === 'cancelled') {
    visibleOrders = visibleOrders.filter(o => o.status === 'Cancelled');
  } else if (currentOrderFilter === 'delivered') {
    visibleOrders = visibleOrders.filter(o => o.status === 'Delivered');
  }

  if (!visibleOrders.length) {
    container.innerHTML = `
      <div class="text-center text-gray-500 dark:text-gray-400">
        No orders found for this filter.
      </div>`;
    return;
  }

  const t = translations[currentLang];

  container.innerHTML = visibleOrders.map(o => {
    const itemsHtml = o.items.map(i => {
      const fullItem = livestock?.find(l => (l._id || l.id) === (i._id || i.id)) || i;
      const weight = i.weight || (fullItem ? fullItem.weight : 'NA');
      const animalType = i.type || (fullItem ? fullItem.type : 'NA');
      const imageUrl = `${API_URL}/livestock/image/${i._id || i.id}`;

      return `
        <div class="flex gap-4 mb-4 border-b border-gray-100 dark:border-gray-600 last:border-0 pb-4 last:pb-0">
          <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-lg flex-shrink-0 overflow-hidden border border-gray-200 dark:border-gray-600">
            <img src="${imageUrl}"
                 alt="${i.name}"
                 class="w-full h-full object-cover"
                 loading="lazy"
                 onerror="this.onerror=null;this.src='https://via.placeholder.com/80?text=Img';" />
          </div>
          <div class="flex-1">
            <p class="font-bold text-gray-800 dark:text-white">${i.name}</p>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              Type: ${animalType || 'NA'}
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              ${t.breed} ${i.breed || 'NA'}
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              ${t.weight} ${weight && weight !== 'NA' ? weight + ' kg' : 'NA'}
            </p>
            <p class="text-sm font-semibold text-green-700 dark:text-green-400 mt-1">
              ${formatINR(i.price)}
            </p>
          </div>
        </div>`;
    }).join('');

    const addressHtml = o.address ? `
      <div class="mt-3 text-sm text-gray-600 dark:text-gray-300">
        <div><strong>Ship to</strong> ${o.address.name}, +91 ${o.address.phone}</div>
        <div>${o.address.line1}</div>
        ${o.address.line2 ? `<div>${o.address.line2}</div>` : ''}
        <div>${o.address.city}, ${o.address.state} - ${o.address.pincode}</div>
        <button
          class="mt-3 inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-gray-300
                 dark:border-gray-600 text-xs text-gray-700 dark:text-gray-200
                 hover:bg-gray-100 dark:hover:bg-gray-700"
          onclick="downloadOrderPdf('${o._id || o.id}')">
          <i data-lucide="download" class="w-4 h-4"></i>
          Download PDF
        </button>
      </div>
    ` : '';

    const trackBtn = (o.status !== 'Cancelled' && o.status !== 'Payment Rejected')
      ? `<button onclick="openTrackModal('${o._id || o.id}')"
                 class="flex-1 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300
                        px-3 py-2 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-800/40 transition">
           Track Order
         </button>`
      : '';

    const cancelBtn = o.status === 'Processing'
      ? `<button onclick="cancelOrder('${o._id || o.id}')"
                 class="flex-1 bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300
                        px-3 py-2 rounded-lg text-sm hover:bg-red-200 dark:hover:bg-red-800/40 transition">
           Cancel Order
         </button>`
      : '';

    return `
      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-100 dark:border-gray-700 mb-4 transition-colors">
        <div class="flex flex-col sm:flex-row justify-between items-start mb-4 gap-2 border-b border-gray-100 dark:border-gray-600 pb-3">
          <div>
            <p class="font-bold text-gray-800 dark:text-white">Order #${String(o._id || o.id || "").slice(-6)}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400">${o.date}</p>
          </div>
          <div class="text-left sm:text-right">
            <p class="font-bold text-green-700 dark:text-green-400">Total ${formatINR(o.total)}</p>
            <span class="${getStatusColor(o.status)} text-xs px-2 py-1 rounded-full font-medium inline-block mt-1">
              ${o.status}
            </span>
          </div>
        </div>

        ${itemsHtml}
        ${addressHtml}

        <div class="mt-4 flex flex-col sm:flex-row gap-3">
          ${trackBtn}
          ${cancelBtn}
        </div>
      </div>`;
  }).join('');

  lucide.createIcons();
}

function setOrderFilter(filter) {
  currentOrderFilter = filter;

  const label = document.getElementById('order-filter-label');
  if (label) {
    if (filter === 'all') label.textContent = 'All Orders';
    if (filter === 'active') label.textContent = 'Active Orders';
    if (filter === 'cancelled') label.textContent = 'Cancelled Orders';
    if (filter === 'delivered') label.textContent = 'Delivered Orders';
  }

  const menu = document.getElementById('order-filter-menu');
  if (menu) menu.classList.add('hidden');

  renderOrders();
}

function initOrderFilterDropdown() {
  const toggle = document.getElementById('order-filter-toggle');
  const menu = document.getElementById('order-filter-menu');
  if (!toggle || !menu) return;

  toggle.addEventListener('click', (e) => {
    e.stopPropagation();
    menu.classList.toggle('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!toggle.contains(e.target) && !menu.contains(e.target)) {
      menu.classList.add('hidden');
    }
  });
}

function downloadOrderPdf(orderId) {
  window.open(`${API_URL}/orders/${orderId}/invoice`, '_blank');
}

document.addEventListener('DOMContentLoaded', initOrderFilterDropdown);

        function renderWishlist() {
            const grid = document.getElementById('wishlist-grid');
            const items = livestock.filter(item => wishlist.includes(item._id)); 
            if (items.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 dark:text-gray-400 py-10">Your wishlist is empty.</div>';
                return;
            }
            const t = translations[currentLang];
            grid.innerHTML = items.map(item => {
                const imageCount = (item.images && item.images.length > 0) ? item.images.length : 1;
                const isSold = item.status === 'Sold';
                const buttons = isSold
                    ? `<button disabled class="w-full bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 cursor-not-allowed px-3 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2">
                        <i data-lucide="slash" class="w-4 h-4"></i> ${t.sold}
                       </button>`
                    : `<div class="flex gap-2 w-full">
                            <button onclick="buyNow('${item._id}')" class="flex-1 bg-green-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-green-700 transition">${t.buy}</button>
                            <button onclick="addToCart('${item._id}')" class="flex-1 bg-gray-900 dark:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-800 dark:hover:bg-gray-500 transition">${t.add_cart}</button>
                       </div>`;
                 const soldOverlay = isSold ?
                    `<div class="absolute inset-0 bg-black/50 z-10 flex items-center justify-center rounded-lg">
                        <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full transform -rotate-12 border-2 border-white shadow-lg">${t.sold}</span>
                     </div>` : '';

                // Generate image slider HTML for wishlist
                let imagesHTML = '';
                if (imageCount > 1) {
                    const imagesArray = Array.from({length: imageCount}, (_, i) =>
                        `<img src="${API_URL}/livestock/image/${item._id}/${i}" alt="${item.name}" class="slider-image w-full h-full object-cover rounded-lg ${isSold ? 'grayscale opacity-75' : ''}" onerror="this.onerror=null; this.src='https://via.placeholder.com/160?text=No+Image';">`
                    ).join('');

                    const dotsHTML = Array.from({length: imageCount}, (_, i) =>
                        `<span class="slider-dot ${i === 0 ? 'active' : ''}" onclick="setSlide('${item._id}', ${i})"></span>`
                    ).join('');

                    imagesHTML = `
                        <div class="image-slider-container h-40 bg-gray-100 dark:bg-gray-700 rounded-lg relative overflow-hidden mb-4">
                            ${soldOverlay}
                            <div class="image-slider-track h-full" id="slider-${item._id}">
                                ${imagesArray}
                            </div>
                            ${imageCount > 1 ? `
                                <button class="slider-nav slider-nav-prev" onclick="prevSlide('${item._id}', ${imageCount})">‚Äπ</button>
                                <button class="slider-nav slider-nav-next" onclick="nextSlide('${item._id}', ${imageCount})">‚Ä∫</button>
                                <div class="slider-dots">${dotsHTML}</div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    const imageUrl = `${API_URL}/livestock/image/${item._id}`;
                    imagesHTML = `
                        <div class="h-40 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center text-6xl mb-4 overflow-hidden relative">
                             ${soldOverlay}
                            <img src="${imageUrl}" alt="${item.name}" class="w-full h-full object-cover rounded-lg ${isSold ? 'grayscale opacity-75' : ''}" onerror="this.onerror=null; this.src='https://via.placeholder.com/160?text=No+Image';">
                        </div>
                    `;
                }

                return `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm relative transition-colors">
                    <button onclick="toggleWishlist('${item._id}')" class="absolute top-4 right-4 text-red-500 bg-white dark:bg-gray-800 rounded-full p-1 shadow hover:bg-red-50 dark:hover:bg-red-900/20 transition z-20">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                    ${imagesHTML}
                    <div class="flex justify-between items-start mb-2">
                         <div class="truncate pr-2">
                             <h3 class="font-bold text-lg text-gray-800 dark:text-white truncate">${item.name}</h3>
                             <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <p>${item.type === 'Goat' ? t.goat : t.sheep} ‚Ä¢ ${t.breed}: ${item.breed}</p>
                                <p>${t.weight}: ${item.weight ? item.weight + ' kg' : 'N/A'}</p>
                             </div>
                         </div>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-xl font-bold text-green-700 dark:text-green-400">${formatINR(item.price)}</span>
                    </div>
                    <div class="mt-3">
                        ${buttons}
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
            window.applyRevealAndPremium(); 
        }
        function renderAddresses() {
            const container = document.getElementById('addresses-container');
            if (!container) return;
            if (addresses.length === 0) {
                container.innerHTML = `
                    <div class="text-sm text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-700/50 border border-dashed border-gray-200 dark:border-gray-600 rounded-lg p-4 text-center">
                        No saved addresses yet. Add an address to use during checkout.
                    </div>
                `;
                return;
            }
            container.innerHTML = addresses.map((a, index) => `
                <div class="border dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-semibold text-gray-800 dark:text-white">${a.name}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">+91 ${a.phone}</p>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-2 py-1 rounded-full whitespace-nowrap">${a.label || 'Default'}</span>
                            <button onclick="editAddress(${index})" class="text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 p-1 rounded">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteAddress(${index})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1 rounded">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300 break-words">${a.line1 || a.line}</p>
                    ${a.line2 ? `<p class="text-sm text-gray-700 dark:text-gray-300 break-words">${a.line2}</p>` : ''}
                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${a.city}, ${a.state} - ${a.pincode}</p>
                </div>
            `).join('');
            lucide.createIcons();
        }
        function addToCart(id) {
            // --- NEW: Duplicate Check ---
            if (cart.some(item => item._id === id)) {
                showToast('This item is already in your cart', 'warning');
                return;
            }

            const item = livestock.find(i => i._id === id);
            if (item) {
                const cartItem = { 
                    _id: item._id, 
                    name: item.name, 
                    price: item.price, 
                    breed: item.breed, 
                    type: item.type,
                    weight: item.weight, 
                    selected: true 
                };
                cart.push(cartItem);
                updateCartBadge();
                saveUserState();
                showToast(`${item.name} added to cart`, 'success');
                const active = document.querySelector('.nav-item.bg-green-600')?.getAttribute('onclick') || '';
                if (active.includes('dashboard')) renderDashboard();
            }
        }
        function removeFromCart(index) {
            cart.splice(index, 1);
            renderCart();
            updateCartBadge();
            saveUserState();
        }
        function toggleCartSelection(index, checked) {
            if (!cart[index]) return;
            cart[index].selected = checked;
            saveUserState();
            renderCart();
        }
        function toggleWishlist(id) {
            const index = wishlist.indexOf(id);
            if (index === -1) {
                if (!wishlist.includes(id)) {
                    wishlist.push(id);
                    showToast('Added to wishlist', 'success');
                } else {
                    showToast('Already in wishlist', 'info');
                }
            } else {
                wishlist.splice(index, 1);
                showToast('Removed from wishlist', 'info');
            }
            saveUserState();
            updateWishlistBadge(); 
            const active = document.querySelector('.nav-item.bg-green-600')?.getAttribute('onclick') || '';
            if (active.includes('wishlist')) renderWishlist();
            if (active.includes('browse')) renderBrowse();
            if (active.includes('dashboard')) renderDashboard();
        }
        function buyNow(id) {
            const item = livestock.find(i => i._id === id);
            if (item) {
                const cartItem = { 
                    _id: item._id, 
                    name: item.name, 
                    price: item.price, 
                    breed: item.breed, 
                    type: item.type,
                    weight: item.weight,
                    selected: true 
                };
                cart = [cartItem]; 
                updateCartBadge();
                saveUserState();
                router('cart');
                setTimeout(() => checkout(), 300);
            }
        }
        function openAddressModal(index) {
            editingAddressIndex = index !== undefined ? index : -1;
            const modal = document.getElementById('address-modal');
            const title = document.getElementById('address-modal-title');
            if (!modal) return;
            if (editingAddressIndex >= 0 && addresses[editingAddressIndex]) {
                title.innerText = 'Edit Address';
                const a = addresses[editingAddressIndex];
                document.getElementById('addr-name').value = a.name || '';
                document.getElementById('addr-phone').value = a.phone || '';
                document.getElementById('addr-line').value = a.line1 || a.line || '';
                document.getElementById('addr-city').value = a.city || '';
                document.getElementById('addr-state').value = a.state || '';
                document.getElementById('addr-pincode').value = a.pincode || '';
            } else {
                title.innerText = 'Add New Address';
                document.getElementById('address-form').reset();
            }
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        function closeAddressModal() {
            const modal = document.getElementById('address-modal');
            if (!modal) return;
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingAddressIndex = -1;
        }
        function editAddress(index) {
            openAddressModal(index);
        }
        async function deleteAddress(index) {
            if (confirm("Are you sure you want to delete this address?")) {
                addresses.splice(index, 1);
                if (addresses.length > 0) {
                    currentAddress = addresses[0];
                } else {
                    currentAddress = null;
                }
                await saveUserState();
                renderAddresses();
                if(pendingCheckoutItems) renderSummary(); 
                showToast("Address deleted", "info");
            }
        }
        async function submitAddress(event) {
            event.preventDefault();
            const name = document.getElementById('addr-name').value.trim();
            const phone = document.getElementById('addr-phone').value.trim();
            const line = document.getElementById('addr-line').value.trim();
            const city = document.getElementById('addr-city').value.trim();
            const state = document.getElementById('addr-state').value.trim();
            const pincode = document.getElementById('addr-pincode').value.trim();
            if (!name || !phone || !line || !city || !state || !pincode) {
                showToast('Please fill all address fields.', 'warning');
                return;
            }
            if (!/^[0-9]{10}$/.test(phone)) {
                showToast('Phone number must be 10 digits.', 'warning');
                return;
            }
            if (!/^[0-9]{6}$/.test(pincode)) {
                showToast('Pincode must be 6 digits.', 'warning');
                return;
            }
            const addressData = { 
                name, 
                phone, 
                line1: line, // Ensured line1 to match backend schema
                city, 
                state, 
                pincode,
                label: addresses.length === 0 ? 'Default' : `Address ${addresses.length + 1}`
            };
            if (editingAddressIndex >= 0) {
                addresses[editingAddressIndex] = { ...addresses[editingAddressIndex], ...addressData };
                showToast('Address updated', 'success');
            } else {
                addresses.push(addressData);
                showToast('Address added', 'success');
            }
            if (!currentAddress || editingAddressIndex === 0) {
                currentAddress = addresses[0];
            }
            await saveUserState(); // Saving to DB
            renderAddresses();
            closeAddressModal();
            if (pendingCheckoutItems && pendingCheckoutItems.length > 0) {
                renderSummary();
            }
        }
        async function checkout() {
            if (cart.length === 0) {
                showToast('Your cart is empty.', 'warning');
                return;
            }
            const itemsToBuy = cart.filter(item => item.selected !== false);
            if (itemsToBuy.length === 0) {
                showToast('Please select at least one item to checkout.', 'warning');
                return;
            }
            
            pendingCheckoutItems = itemsToBuy;
            
            if (addresses.length === 0) {
                openAddressModal();
                return;
            }
            if (!currentAddress && addresses.length > 0) {
                currentAddress = addresses[0];
            }
            
            router('summary');
            renderSummary();
        }
        
        function renderSummary() {
            if(!pendingCheckoutItems) return;
            
            const addrListContainer = document.getElementById('summary-address-list');
            const itemsContainer = document.getElementById('summary-items');
            const subtotalEl = document.getElementById('summary-subtotal');
            const totalEl = document.getElementById('summary-total');
            
            if (addresses.length > 0) {
                addrListContainer.innerHTML = addresses.map((addr, idx) => {
                    const isChecked = currentAddress === addr || (currentAddress && currentAddress.name === addr.name && currentAddress.line1 === addr.line1); 
                    if(isChecked) currentAddress = addr; 

                    return `
                    <label class="flex items-start gap-3 border p-3 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition ${isChecked ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-gray-200 dark:border-gray-700'}">
                        <input type="radio" name="selectedAddress" class="mt-1" ${isChecked ? 'checked' : ''} onchange="selectAddress(${idx})">
                        <div class="text-sm text-gray-700 dark:text-gray-300">
                            <p class="font-bold text-gray-900 dark:text-white">${addr.name}, <span class="font-normal text-gray-500 dark:text-gray-400">+91 ${addr.phone}</span></p>
                            <p>${addr.line1 || addr.line}</p>
                            <p>${addr.city}, ${addr.state} - ${addr.pincode}</p>
                        </div>
                    </label>
                    `;
                }).join('');
            } else {
                addrListContainer.innerHTML = `<p class="text-red-500 text-sm">No address found. Please add one.</p>`;
            }
            
            let total = 0;
            itemsContainer.innerHTML = pendingCheckoutItems.map(item => {
                total += (item.price || 0);
                const imageUrl = `${API_URL}/livestock/image/${item._id}`;
                return `
                    <div class="flex gap-4 border-b border-gray-100 dark:border-gray-700 pb-4 last:border-0 last:pb-0">
                         <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-lg flex-shrink-0 overflow-hidden border border-gray-200 dark:border-gray-600">
                             <img src="${imageUrl}" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://via.placeholder.com/64?text=Img';">
                         </div>
                         <div class="flex-1">
                             <p class="font-bold text-gray-800 dark:text-white">${item.name}</p>
                             <p class="text-xs text-gray-500 dark:text-gray-400">Type: ${item.type || 'N/A'}</p> <p class="text-xs text-gray-500 dark:text-gray-400">Breed: ${item.breed}</p>
                             <p class="text-xs text-gray-500 dark:text-gray-400">Weight: ${item.weight ? item.weight + ' kg' : 'N/A'}</p>
                         </div>
                         <p class="font-bold text-gray-800 dark:text-white">${formatINR(item.price)}</p>
                    </div>
                `;
            }).join('');
            
            subtotalEl.innerText = formatINR(total);
            totalEl.innerText = formatINR(total);
        }

        function selectAddress(index) {
            currentAddress = addresses[index];
            renderSummary(); 
        }
        
        async function proceedToPayment() {
            if(!pendingCheckoutItems || pendingCheckoutItems.length === 0) return;
            if(!currentAddress) {
                showToast('Please select a delivery address', 'error');
                return;
            }
            await createOrder(pendingCheckoutItems);
        }

        async function createOrder(itemsToBuy) {
            const total = itemsToBuy.reduce((sum, item) => sum + (item.price || 0), 0);
            try {
                const payRes = await fetch(`${API_URL}/payment/create`, {
                    method: "POST",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount: total })
                });
                const payData = await payRes.json();
                if (!payRes.ok) {
                    showToast(payData.message || 'Failed to start payment', 'error');
                    return;
                }
                showPaymentUI(payData.upiString, payData.paymentId, itemsToBuy, total);
            } catch (err) {
                console.error('createOrder error', err);
                showToast('Payment initiation failed', 'error');
            }
        }
        
        function openTrackModal(orderId) {
            const order = orders.find(o => o._id === orderId);
            if(!order) return;
            
            const modal = document.getElementById('track-modal');
            const content = document.getElementById('track-content');
            
            const steps = [
                { status: 'Processing', label: 'Order Placed & Processing' },
                { status: 'Shipped', label: 'Shipped' },
                { status: 'Delivered', label: 'Delivered' }
            ];
            
            let currentStepIndex = steps.findIndex(s => s.status === order.status);
            if(currentStepIndex === -1) currentStepIndex = 0; 
            
            const itemsList = order.items.map(i => `<li class="text-sm text-gray-600 dark:text-gray-400">${i.name} (${i.breed || ''})</li>`).join('');
            
            const stepsHtml = steps.map((s, idx) => {
                const isActive = idx <= currentStepIndex;
                const isCurrent = idx === currentStepIndex;
                const colorClass = isActive ? 'bg-green-600 border-green-600 text-white' : 'bg-white dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-400';
                
                return `
                <div class="flex items-start gap-4 relative">
                    <div class="flex flex-col items-center">
                        <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center z-10 ${colorClass}">
                            ${isActive ? '<i data-lucide="check" class="w-4 h-4"></i>' : (idx + 1)}
                        </div>
                        ${idx < steps.length - 1 ? `<div class="w-0.5 h-10 ${isActive ? 'bg-green-600' : 'bg-gray-200 dark:bg-gray-700'} -my-1"></div>` : ''}
                    </div>
                    <div class="pt-1">
                        <p class="font-semibold ${isActive ? 'text-gray-900 dark:text-white' : 'text-gray-400 dark:text-gray-500'}">${s.label}</p>
                        ${isCurrent ? '<p class="text-xs text-green-600 dark:text-green-400">Current Status</p>' : ''}
                    </div>
                </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div class="border-b dark:border-gray-700 pb-4 mb-4">
                    <p class="font-bold text-gray-800 dark:text-white">Order #${String(order._id).slice(-6)}</p>
                    <ul class="list-disc pl-5 mt-2 space-y-1">${itemsList}</ul>
                </div>
                <div class="space-y-0">
                    ${stepsHtml}
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeTrackModal() {
            const modal = document.getElementById('track-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function updateCartBadge() {
            const badges = [document.getElementById('cart-badge'), document.getElementById('header-cart-badge')];
            badges.forEach(b => {
                if (!b) return;
                b.innerText = cart.length;
                if (cart.length > 0) b.classList.remove('hidden');
                else b.classList.add('hidden');
            });
        }
        
        function updateWishlistBadge() {
            const badge = document.getElementById('wishlist-badge');
            if (!badge) return;
            badge.innerText = getVisibleWishlistCount();
            if (getVisibleWishlistCount() > 0) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        function getStatusColor(status) {
            if (status === 'Shipped') return 'bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300';
            if (status === 'Delivered') return 'bg-gray-800 text-white dark:bg-gray-600';
            if (status === 'Processing') return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/40 dark:text-yellow-300';
            if (status === 'Cancelled') return 'bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300';
            return 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200';
        }
        
        function initApp() {
            if (appInitialized) return;
            appInitialized = true;
            initTheme(); 
            updateCartBadge();
            updateWishlistBadge(); 
            updateNotificationBadge(); 
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateEl = document.getElementById('current-date');
            if (dateEl) {
                dateEl.innerText = new Date().toLocaleDateString('en-IN', dateOptions);
            }
            router('dashboard');
            
            autoRefreshInterval = setInterval(() => {
                loadData();
            }, 2000);
            
            initPullToRefresh();
        }

        function initPullToRefresh() {
            let startY = 0;
            let currentY = 0;
            let isDragging = false;
            const threshold = 120; 
            const indicator = document.getElementById('pull-refresh-indicator');
            const container = document.getElementById('content-area'); 
            
            if(!container) return;

            container.addEventListener('touchstart', (e) => {
                if (container.scrollTop <= 0) {
                    startY = e.touches[0].clientY;
                    isDragging = true;
                }
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 0 && container.scrollTop <= 0) {
                    if (diff > threshold) {
                        indicator.style.top = '20px'; 
                        indicator.querySelector('.spinner').style.transform = `rotate(${diff}deg)`;
                    } else {
                         indicator.style.top = (diff / 2 - 50) + 'px'; 
                    }
                }
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                const diff = currentY - startY;
                isDragging = false;
                
                if (diff > threshold && container.scrollTop <= 0) {
                    indicator.style.top = '20px';
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    indicator.style.top = '-50px';
                }
                startY = 0;
                currentY = 0;
            });
        }

        function attachEventListeners() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            if (loginForm) loginForm.addEventListener('submit', handleLogin);
            if (registerForm) registerForm.addEventListener('submit', handleRegister);
            
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('profile-menu');
                const btn = document.getElementById('profile-button');
                if (menu && btn) {
                    if (!menu.contains(e.target) && !btn.contains(e.target)) {
                        toggleProfileMenu(false);
                    }
                }

                const notifMenu = document.getElementById('notification-menu');
                const notifBtn = document.getElementById('notification-button');
                if (notifMenu && notifBtn) {
                    if (!notifMenu.contains(e.target) && !notifBtn.contains(e.target)) {
                        toggleNotificationMenu(false);
                    }
                }
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            attachEventListeners();
            checkAuth();
            lucide.createIcons();
        });
        
        function showPaymentUI(upiString, paymentId, itemsToBuy, total) {
            proofUploaded = false; // Reset on new payment
            document.querySelectorAll('.lm-pay-popup').forEach(e => e.remove());
            const payBox = document.createElement("div");
            payBox.className = "lm-pay-popup fixed inset-0 flex items-center justify-center bg-black/60 z-50 px-4 backdrop-blur-sm";
            payBox.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-md p-6 rounded-2xl text-gray-800 dark:text-gray-100 border border-gray-200 dark:border-gray-700 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold mb-3">Complete Payment</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Scan QR code or use UPI apps.</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <a href="${upiString}" class="pay-icon-btn flex flex-col items-center justify-center p-4 border dark:border-gray-600 rounded-xl hover:bg-purple-50 dark:hover:bg-purple-900/20 transition bg-white dark:bg-gray-700">
                            <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/phonepe-icon.png" alt="PhonePe" class="w-12 h-12 mb-2 object-contain">
                        </a>
                        <a href="${upiString}" class="pay-icon-btn flex flex-col items-center justify-center p-4 border dark:border-gray-600 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition bg-white dark:bg-gray-700">
                            <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/google-pay-icon.png" alt="GPay" class="w-12 h-12 mb-2 object-contain">
                        </a>
                        <a href="${upiString}" class="pay-icon-btn flex flex-col items-center justify-center p-4 border dark:border-gray-600 rounded-xl hover:bg-blue-50 dark:hover:bg-blue-900/20 transition bg-white dark:bg-gray-700">
                            <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/paytm-icon.png" alt="Paytm" class="w-12 h-12 mb-2 object-contain">
                        </a>
                        <a href="${upiString}" class="pay-icon-btn flex flex-col items-center justify-center p-4 border dark:border-gray-600 rounded-xl hover:bg-orange-50 dark:hover:bg-orange-900/20 transition bg-white dark:bg-gray-700">
                            <img src="https://uxwing.com/wp-content/themes/uxwing/download/brands-and-social-media/bhim-upi-icon.png" alt="BHIM" class="w-12 h-12 mb-2 object-contain" onerror="this.src='https://placehold.co/100x100/orange/white?text=BHIM'">
                        </a>
                    </div>

                    <div class="mt-4 text-center border-b dark:border-gray-700 pb-4 mb-4">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(upiString)}" class="mx-auto rounded-lg border dark:border-gray-600 shadow-sm"/>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-3 font-semibold">Scan & Pay ‚Ä¢ Amount: ‚Çπ${total}</p>
                    </div>

                    <div class="space-y-3">
                        <p class="text-sm font-medium text-gray-700 dark:text-gray-300">Upload Payment Screenshot</p>
                        <div id="proof-container" class="relative">
                            <input type="file" id="payment-proof-input" accept="image/*" class="hidden" onchange="handleProofUpload(this)">
                            <button onclick="document.getElementById('payment-proof-input').click()" class="w-full flex items-center justify-center gap-2 border-2 border-dashed border-gray-300 dark:border-gray-600 py-4 rounded-xl hover:border-emerald-500 transition-colors" id="upload-btn-ui">
                                <i data-lucide="upload-cloud" class="w-5 h-5 text-gray-400"></i>
                                <span class="text-sm text-gray-500" id="proof-text">Select Screenshot</span>
                            </button>
                        </div>
                    </div>

                    <button id="lm-paid-btn" class="w-full bg-emerald-600 text-white py-3 mt-6 rounded-xl font-bold text-lg shadow-lg hover:bg-emerald-700 transition transform active:scale-95">
                        I Have Paid
                    </button>
                    <button id="lm-cancel-btn" class="w-full text-gray-500 dark:text-gray-400 mt-3 text-sm font-medium hover:text-gray-700 dark:hover:text-gray-200">Cancel Payment</button>
                </div>
            `;
            document.body.appendChild(payBox);
            lucide.createIcons();

            document.getElementById('lm-paid-btn').onclick = async function () {
  if (!proofUploaded) {
    showToast('Please upload screenshot of proof', 'warning');
    return;
  }
  if (isConfirmingPayment) return;

  isConfirmingPayment = true;
  const btn = document.getElementById('lm-paid-btn');
  if (btn) {
    btn.disabled = true;
    btn.classList.add('opacity-70', 'cursor-not-allowed');
    btn.textContent = 'Processing...';
  }

  try {
    await confirmPayment(paymentId, itemsToBuy, total);
  } finally {
    isConfirmingPayment = false;
    const b = document.getElementById('lm-paid-btn');
    if (b) {
      b.disabled = false;
      b.classList.remove('opacity-70', 'cursor-not-allowed');
      b.textContent = 'I Have Paid';
    }
  }
};
;
            document.getElementById('lm-cancel-btn').onclick = function() {
                document.querySelectorAll('.lm-pay-popup').forEach(e => e.remove());
            };
        }

        function handleProofUpload(input) {
            if (input.files && input.files[0]) {
                proofUploaded = true;
                const btnUi = document.getElementById('upload-btn-ui');
                const textUi = document.getElementById('proof-text');
                btnUi.classList.add('border-emerald-500', 'bg-emerald-50', 'dark:bg-emerald-900/20');
                textUi.innerText = "Screenshot Selected: " + input.files[0].name;
                textUi.classList.remove('text-gray-500');
                textUi.classList.add('text-emerald-600', 'dark:text-emerald-400');
                showToast('Proof attached successfully', 'success');
            }
        }

        async function confirmPayment(paymentId, items, total) {
            const file = document.getElementById('payment-proof-input').files[0];
            const fd = new FormData();
            fd.append('items', JSON.stringify(items.map(i => ({
                _id: i._id || i.id, name: i.name, price: i.price, breed: i.breed, type: i.type, weight: i.weight
            }))));
            fd.append('address', JSON.stringify(currentAddress));
            fd.append('total', total);
            fd.append('date', new Date().toLocaleString('en-IN', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }));
            fd.append('paymentProof', file);

            try {
                const res = await fetch(`${API_URL}/payment/confirm`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    showToast(data.message || 'Payment not verified', 'error');
                    return;
                }
                
                const ordRes = await fetch(`${API_URL}/orders`, {
                    method: 'POST',
                    credentials: 'include',
                    body: fd
                });
                if (!ordRes.ok) {
                    const err = await ordRes.json();
                    showToast(err.message || 'Order creation failed', 'error');
                    return;
                }
        // Ensure address is stored in user saved addresses
        if (currentAddress) {
            const exists = (addresses || []).some(a =>
                a.name === currentAddress.name &&
                a.phone === currentAddress.phone &&
                a.line1 === currentAddress.line1 &&
                a.pincode === currentAddress.pincode
            );
            if (!exists) {
                addresses.push({ ...currentAddress });
                await saveUserState();
            }
        }

                
                cart = cart.filter(c => !pendingCheckoutItems.some(p => p._id === c._id));
                pendingCheckoutItems = null;
                await saveUserState();
                showToast('Payment Successful! Order Placed.', 'success');
                
                document.querySelectorAll('.lm-pay-popup').forEach(e => e.remove());
                
                await loadData();
                router('orders');
            } catch (err) {
                console.error('confirmPayment error', err);
                showToast('Payment confirmation failed', 'error');
            }
        }
        async function cancelOrder(id) {
            try {
                const res = await fetch(`${API_URL}/orders/${id}/cancel`, {
                    method: "PUT",
                    credentials: "include"
                });
                const data = await res.json();
                if (!res.ok) {
                    showToast(data.message || 'Cancel failed', 'error');
                    return;
                }
                showToast('Order cancelled', 'success');
                await loadData();
                router('orders');
            } catch (err) {
                console.error('cancelOrder error', err);
                showToast('Cancel failed', 'error');
            }
        }

        // --- REUPLOAD LOGIC ---
        function openReuploadUI(orderId, total) {
            proofUploaded = false;
            const popup = document.createElement('div');
            popup.className = 'lm-pay-popup fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm p-4';
            popup.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                    <h3 class="font-bold text-xl mb-4 text-center text-red-600">Re-upload Proof</h3>
                    <p class="text-center text-sm text-gray-500 mb-4">Please upload a clearer screenshot for Order #${orderId.slice(-6)}</p>
                    <label class="block w-full border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 transition" id="proof-lbl">
                        <span class="text-sm text-gray-500">Select New Screenshot</span>
                        <input type="file" id="reupload-input" class="hidden" accept="image/*" onchange="handleProof(this)">
                    </label>
                    <button id="reupload-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-4">Submit</button>
                    <button onclick="this.closest('.lm-pay-popup').remove()" class="w-full text-gray-500 text-sm mt-2">Cancel</button>
                </div>
            `;
            document.body.appendChild(popup);

            document.getElementById('reupload-btn').onclick = async () => {
                const file = document.getElementById('reupload-input').files[0];
                if(!file) return showToast('Please select a file', 'warning');
                
                const fd = new FormData();
                fd.append('paymentProof', file);
                
                const res = await fetch(`${API_URL}/orders/${orderId}/reupload`, { method: 'PUT', body: fd });
                if(res.ok) {
                    document.querySelector('.lm-pay-popup').remove();
                    showToast('Proof Submitted!', 'success');
                    loadData();
                }
            };
        }

        function handleProof(input) {
            if(input.files[0]) {
                proofUploaded = true;
                const lbl = document.getElementById('proof-lbl');
                lbl.classList.add('border-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
                lbl.querySelector('span').innerText = "‚úì Proof Selected: " + input.files[0].name;
                lbl.querySelector('span').classList.add('text-blue-600');
            }
        }

        // Image Slider Functions
        const sliderPositions = {};

        function setSlide(itemId, index) {
            sliderPositions[itemId] = index;
            const track = document.getElementById('slider-' + itemId);
            if (track) {
                track.style.transform = `translateX(-${index * 100}%)`;
                updateDots(itemId, index);
            }
        }

        function nextSlide(itemId, totalImages) {
            const currentPos = sliderPositions[itemId] || 0;
            const nextPos = (currentPos + 1) % totalImages;
            setSlide(itemId, nextPos);
        }

        function prevSlide(itemId, totalImages) {
            const currentPos = sliderPositions[itemId] || 0;
            const prevPos = (currentPos - 1 + totalImages) % totalImages;
            setSlide(itemId, prevPos);
        }

        function updateDots(itemId, activeIndex) {
            const slider = document.getElementById('slider-' + itemId);
            if (!slider) return;
            const container = slider.closest('.image-slider-container');
            if (!container) return;
            const dots = container.querySelectorAll('.slider-dot');
            dots.forEach((dot, i) => {
                if (i === activeIndex) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }
    </script>
    <script>
    (function(){
      window.animatePage = function(viewId){
        try {
          const view = document.getElementById(viewId);
          if(!view) return;
          view.classList.add("page-enter");
          requestAnimationFrame(()=> {
            view.classList.add("page-enter-active");
            setTimeout(()=> {
              view.classList.remove("page-enter", "page-enter-active");
            }, 800);
          });
        } catch(e){ console.error("animatePage error", e); }
      };

      const revealObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add("reveal-visible");
            revealObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.18 });

      window.applyRevealAndPremium = function(){
        try {
          const grid = document.getElementById('livestock-grid');
          if(!grid) return;
          Array.from(grid.children).forEach(el => {
            el.classList.add('reveal','card-premium');
            revealObserver.observe(el);
          });
        } catch(e){ console.error("applyReveal error", e); }
      };

      if (window.router) {
        const __old_router = window.router.bind(window);
        window.router = function(viewName){
          try {
            __old_router(viewName);
          } catch(e){
            console.error("router wrapper old failed", e);
          }
          try {
            animatePage('view-' + viewName);
          } catch(e){ }
          if (viewName === 'browse') {
            setTimeout(() => { applyRevealAndPremium(); }, 100);
          } else {
            setTimeout(() => { applyRevealAndPremium(); }, 200);
          }
          setTimeout(() => {
            document.querySelectorAll('button:not(.btn-press)').forEach(b => b.classList.add('btn-press'));
            document.querySelectorAll('.bg-green-600, .bg-gray-900').forEach(b => b.classList.add('btn-glow'));
          }, 150);
        };
      } else {
        const waitRouter = setInterval(() => {
          if (window.router) {
            clearInterval(waitRouter);
            const __old_router = window.router.bind(window);
            window.router = function(viewName){
              try { __old_router(viewName); } catch(e){}
              try { animatePage('view-' + viewName); } catch(e){}
              if (viewName === 'browse') setTimeout(() => { applyRevealAndPremium(); }, 100);
              else setTimeout(() => { applyRevealAndPremium(); }, 200);
              setTimeout(() => {
                document.querySelectorAll('button:not(.btn-press)').forEach(b => b.classList.add('btn-press'));
                document.querySelectorAll('.bg-green-600, .bg-gray-900').forEach(b => b.classList.add('btn-glow'));
              }, 150);
            };
          }
        }, 150);
      }

      if (window.showToast) {
        const _oldToast = window.showToast.bind(window);
        window.showToast = function(message, type){
          _oldToast(message, type);
          setTimeout(() => {
            try {
              const container = document.getElementById('toast-container');
              if (!container) return;
              const last = container.lastElementChild;
              if (last) last.classList.add('toast-anim');
            } catch(e){ console.error("toast patch error", e); }
          }, 10);
        };
      } else {
        const waitToast = setInterval(() => {
          if (window.showToast) {
            clearInterval(waitToast);
            const _oldToast = window.showToast.bind(window);
            window.showToast = function(message, type){
              _oldToast(message, type);
              setTimeout(() => {
                try {
                  const container = document.getElementById('toast-container');
                  if (!container) return;
                  const last = container.lastElementChild;
                  if (last) last.classList.add('toast-anim');
                } catch(e){}
              }, 120);
            };
          }
        }, 120);
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('button:not(.btn-press)').forEach(b => b.classList.add('btn-press'));
        document.querySelectorAll('.bg-green-600, .bg-gray-900').forEach(b => b.classList.add('btn-glow'));
        setTimeout(() => { applyRevealAndPremium(); }, 300);
      });

    })();
    </script>

<div id="chatbot-box"
     class="fixed inset-0 z-[10000] hidden flex-col bg-white dark:bg-gray-900">

  <div class="flex items-center justify-between bg-blue-600 text-white px-4 py-3">
    <span id="chatbot-header" class="font-semibold text-sm">
      üêê Goat & Sheep Support
    </span>
    <button onclick="closeChatbot()" class="text-lg font-bold">‚úï</button>
  </div>

  <div id="lang-buttons" class="flex justify-center gap-2 p-2 bg-gray-100 dark:bg-gray-800">
    <button onclick="setLang('en')" class="px-3 py-1 rounded text-xs bg-gray-300 dark:bg-gray-700">EN</button>
    <button onclick="setLang('te')" class="px-3 py-1 rounded text-xs bg-gray-300 dark:bg-gray-700">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</button>
    <button onclick="setLang('hi')" class="px-3 py-1 rounded text-xs bg-gray-300 dark:bg-gray-700">‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
    <button onclick="setLang('ta')" class="px-3 py-1 rounded text-xs bg-gray-300 dark:bg-gray-700">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
  </div>

  <div id="chatbot-messages"
       class="flex-1 overflow-y-auto p-3 bg-gray-100 dark:bg-gray-800"></div>

  <div id="quick-replies" class="flex flex-wrap gap-2 p-2"></div>

  <a id="whatsapp-btn"
     href="https://wa.me/91XXXXXXXXXX"
     target="_blank"
     class="block text-center bg-green-500 text-white py-2 text-sm">
  </a>

  <div class="flex border-t border-gray-300 dark:border-gray-700">
    <input id="chatbot-text"
           class="flex-1 px-3 py-2 text-sm bg-white dark:bg-gray-900 outline-none"
           placeholder="Type your message..." />
    <button onclick="sendChat()"
            class="bg-blue-600 text-white px-4">
      Send
    </button>
  </div>
</div>
<script>
/* ===== CHATBOT AUTO BIND ===== */
const chatbotBox = document.getElementById("chatbot-box");
const msgs = document.getElementById("chatbot-messages");
const quickBox = document.getElementById("quick-replies");

// --- UPDATED LINKS ---
const WHATSAPP_CHANNEL_LINK = "https://whatsapp.com/channel/0029VaD8mYTAInPij7sCeR2K";
const YOUTUBE_LINK = "https://www.youtube.com/@livestocksheepsandgoatssel110";

// --- UPDATED CONTACTS TEXT ---
const CONTACT_TEXT = "üìû 9000274439 - Suryachandram garu\nüìû 9908817975 - Srinivasa Rao garu";

function openChatbot(){
  chatbotBox.classList.remove("hidden");
  chatbotBox.classList.add("flex");
}
function closeChatbot(){
  chatbotBox.classList.add("hidden");
  chatbotBox.classList.remove("flex");
}

/* Attach to existing Support -> Start Chat button automatically */
document.addEventListener("DOMContentLoaded", ()=>{
  const supportView = document.getElementById("view-support");
  if(supportView){
    const btn = supportView.querySelector("button");
    if(btn) btn.addEventListener("click", openChatbot);
  }
  
  // Update the main WhatsApp button to point to the Channel
  const waBtn = document.getElementById("whatsapp-btn");
  if(waBtn) {
    waBtn.href = WHATSAPP_CHANNEL_LINK;
    waBtn.innerText = "üí¨ Join WhatsApp Channel"; // Default text, will be overwritten by language set
  }
});

const LANG = {
  en: {
    header: "üêê Goat & Sheep Support",
    input: "Type your message...",
    wa: "üí¨ Join WhatsApp Channel",
    quick: ["Goat", "Sheep", "Price", "YouTube", "Address", "Contact"],
    reply: {
      goat: "üêê Healthy goats available.",
      sheep: "üêë Quality sheep available.",
      price: "üí∞ Prices depend on breed and weight.",
      youtube: `‚ñ∂Ô∏è Watch our videos here:\n<a href="${YOUTUBE_LINK}" target="_blank" class="text-blue-600 underline">Click to Visit YouTube</a>`,
      address: "üìç Kaspapentapadu near high school, West Godavari, Andhra Pradesh", 
      contact: CONTACT_TEXT,
      default: "Please ask about goats or sheep."
    }
  },
  te: {
    header: "üêê ‡∞Æ‡±á‡∞ï & ‡∞ó‡±ä‡∞∞‡±ç‡∞∞‡±Ü ‡∞Æ‡∞¶‡±ç‡∞¶‡∞§‡±Å",
    input: "‡∞Æ‡±Ä ‡∞∏‡∞Ç‡∞¶‡±á‡∞∂‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞ü‡±à‡∞™‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø...",
    wa: "üí¨ ‡∞µ‡∞æ‡∞ü‡±ç‡∞∏‡∞æ‡∞™‡±ç ‡∞õ‡∞æ‡∞®‡±Ü‡∞≤‡±ç‚Äå‡∞≤‡±ã ‡∞ö‡±á‡∞∞‡∞Ç‡∞°‡∞ø",
    quick: ["‡∞Æ‡±á‡∞ï", "‡∞ó‡±ä‡∞∞‡±ç‡∞∞‡±Ü", "‡∞ß‡∞∞", "‡∞Ø‡±Ç‡∞ü‡±ç‡∞Ø‡±Ç‡∞¨‡±ç", "‡∞ö‡∞ø‡∞∞‡±Å‡∞®‡∞æ‡∞Æ‡∞æ", "‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø"],
    reply: {
      goat: "üêê ‡∞Ü‡∞∞‡±ã‡∞ó‡±ç‡∞Ø‡∞ï‡∞∞‡∞Æ‡±à‡∞® ‡∞Æ‡±á‡∞ï‡∞≤‡±Å ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞®‡∞æ‡∞Ø‡∞ø.",
      sheep: "üêë ‡∞®‡∞æ‡∞£‡±ç‡∞Ø‡∞Æ‡±à‡∞® ‡∞ó‡±ä‡∞∞‡±ç‡∞∞‡±Ü‡∞≤‡±Å ‡∞Ö‡∞Ç‡∞¶‡±Å‡∞¨‡∞æ‡∞ü‡±Å‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞®‡∞æ‡∞Ø‡∞ø.",
      price: "üí∞ ‡∞ß‡∞∞‡∞≤‡±Å ‡∞ú‡∞æ‡∞§‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞¨‡∞∞‡±Å‡∞µ‡±Å‡∞™‡±à ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞™‡∞°‡∞ø ‡∞â‡∞Ç‡∞ü‡∞æ‡∞Ø‡∞ø.",
      youtube: `‚ñ∂Ô∏è ‡∞Æ‡∞æ ‡∞µ‡±Ä‡∞°‡∞ø‡∞Ø‡±ã‡∞≤‡∞®‡±Å ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø:\n<a href="${YOUTUBE_LINK}" target="_blank" class="text-blue-600 underline">YouTube ‡∞≤‡∞ø‡∞Ç‡∞ï‡±ç</a>`,
      address: "üìç ‡∞ï‡∞∏‡±ç‡∞™‡∞æ‡∞™‡±Ü‡∞Ç‡∞ü‡∞™‡∞æ‡∞°‡±Å ‡∞π‡±à ‡∞∏‡±ç‡∞ï‡±Ç‡∞≤‡±ç ‡∞¶‡∞ó‡±ç‡∞ó‡∞∞, ‡∞™‡∞∂‡±ç‡∞ö‡∞ø‡∞Æ ‡∞ó‡±ã‡∞¶‡∞æ‡∞µ‡∞∞‡∞ø, ‡∞Ü‡∞Ç‡∞ß‡±ç‡∞∞‡∞™‡±ç‡∞∞‡∞¶‡±á‡∞∂‡±ç",
      contact: CONTACT_TEXT,
      default: "‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡±á‡∞ï‡∞≤‡±Å ‡∞≤‡±á‡∞¶‡∞æ ‡∞ó‡±ä‡∞∞‡±ç‡∞∞‡±Ü‡∞≤ ‡∞ó‡±Å‡∞∞‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞Ö‡∞°‡∞ó‡∞Ç‡∞°‡∞ø."
    }
  },
  hi: {
    header: "üêê ‡§¨‡§ï‡§∞‡•Ä ‡§î‡§∞ ‡§≠‡•á‡§°‡§º ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",
    input: "‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§≤‡§ø‡§ñ‡•á‡§Ç...",
    wa: "üí¨ ‡§µ‡•ç‡§π‡§æ‡§ü‡•ç‡§∏‡§è‡§™ ‡§ö‡•à‡§®‡§≤ ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á‡§Ç",
    quick: ["‡§¨‡§ï‡§∞‡•Ä", "‡§≠‡•á‡§°‡§º", "‡§ï‡•Ä‡§Æ‡§§", "‡§Ø‡•Ç‡§ü‡•ç‡§Ø‡•Ç‡§¨", "‡§™‡§§‡§æ", "‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï"],
    reply: {
      goat: "üêê ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§¨‡§ï‡§∞‡§ø‡§Ø‡§æ‡§Ç ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡§Ç‡•§",
      sheep: "üêë ‡§Ö‡§ö‡•ç‡§õ‡•Ä ‡§®‡§∏‡•ç‡§≤ ‡§ï‡•Ä ‡§≠‡•á‡§°‡§º‡•á‡§Ç ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à‡§Ç‡•§",
      price: "üí∞ ‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç ‡§®‡§∏‡•ç‡§≤ ‡§î‡§∞ ‡§µ‡§ú‡§® ‡§™‡§∞ ‡§®‡§ø‡§∞‡•ç‡§≠‡§∞ ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à‡§Ç‡•§",
      youtube: `‚ñ∂Ô∏è ‡§π‡§Æ‡§æ‡§∞‡•á ‡§µ‡•Ä‡§°‡§ø‡§Ø‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§¶‡•á‡§ñ‡•á‡§Ç:\n<a href="${YOUTUBE_LINK}" target="_blank" class="text-blue-600 underline">YouTube ‡§≤‡§ø‡§Ç‡§ï</a>`,
      address: "üìç ‡§ï‡§∏‡•ç‡§™‡§æ‡§™‡•á‡§Ç‡§ü‡§æ‡§™‡§æ‡§°‡•Å ‡§π‡§æ‡§à ‡§∏‡•ç‡§ï‡•Ç‡§≤ ‡§ï‡•á ‡§™‡§æ‡§∏, ‡§™‡§∂‡•ç‡§ö‡§ø‡§Æ ‡§ó‡•ã‡§¶‡§æ‡§µ‡§∞‡•Ä, ‡§Ü‡§Ç‡§ß‡•ç‡§∞ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂",
      contact: CONTACT_TEXT,
      default: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§ï‡§∞‡§ø‡§Ø‡•ã‡§Ç ‡§Ø‡§æ ‡§≠‡•á‡§°‡§º‡•ã‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§™‡•Ç‡§õ‡•á‡§Ç‡•§"
    }
  },
  ta: {
    header: "üêê ‡ÆÜ‡Æü‡ØÅ & ‡Æö‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡Æ±‡Æø ‡ÆÜ‡Æü‡ØÅ ‡ÆÜ‡Æ§‡Æ∞‡Æµ‡ØÅ",
    input: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡Æø‡ÆØ‡Øà ‡Æ§‡Æü‡Øç‡Æü‡Æö‡Øç‡Æö‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç...",
    wa: "üí¨ ‡Æµ‡Ææ‡Æü‡Øç‡Æ∏‡Øç‡ÆÖ‡Æ™‡Øç ‡Æö‡Øá‡Æ©‡Æ≤‡Æø‡Æ≤‡Øç ‡Æö‡Øá‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç",
    quick: ["‡ÆÜ‡Æü‡ØÅ", "‡Æö‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡Æ±‡Æø", "‡Æµ‡Æø‡Æ≤‡Øà", "‡ÆØ‡ØÇ‡Æü‡Æø‡ÆØ‡ØÇ‡Æ™‡Øç", "‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø", "‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ"],
    reply: {
      goat: "üêê ‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ‡ÆÆ‡Ææ‡Æ© ‡ÆÜ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ©.",
      sheep: "üêë ‡Æ§‡Æ∞‡ÆÆ‡Ææ‡Æ© ‡Æö‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡Æ±‡Æø ‡ÆÜ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ©.",
      price: "üí∞ ‡Æµ‡Æø‡Æ≤‡Øà‡Æï‡Æ≥‡Øç ‡Æá‡Æ©‡ÆÆ‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æü‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Øä‡Æ±‡ØÅ‡Æ§‡Øç‡Æ§‡Æ§‡ØÅ.",
      youtube: `‚ñ∂Ô∏è ‡Æé‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡ØÄ‡Æü‡Æø‡ÆØ‡Øã‡Æï‡Øç‡Æï‡Æ≥‡Øà ‡Æá‡Æô‡Øç‡Æï‡Øá ‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:\n<a href="${YOUTUBE_LINK}" target="_blank" class="text-blue-600 underline">YouTube ‡Æá‡Æ£‡Øà‡Æ™‡Øç‡Æ™‡ØÅ</a>`,
      address: "üìç ‡Æï‡Æ∏‡Øç‡Æ™‡Ææ‡Æ™‡ØÜ‡Æ£‡Øç‡Æü‡Æ™‡Ææ‡Æü‡ØÅ ‡Æâ‡ÆØ‡Æ∞‡Øç‡Æ®‡Æø‡Æ≤‡Øà‡Æ™‡Øç ‡Æ™‡Æ≥‡Øç‡Æ≥‡Æø ‡ÆÖ‡Æ∞‡ØÅ‡Æï‡Æø‡Æ≤‡Øç, ‡ÆÆ‡Øá‡Æ±‡Øç‡Æï‡ØÅ ‡Æï‡Øã‡Æ§‡Ææ‡Æµ‡Æ∞‡Æø, ‡ÆÜ‡Æ®‡Øç‡Æ§‡Æø‡Æ∞ ‡Æ™‡Æø‡Æ∞‡Æ§‡Øá‡Æö‡ÆÆ‡Øç",
      contact: CONTACT_TEXT,
      default: "‡ÆÜ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æö‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡Æ±‡Æø ‡ÆÜ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç ‡Æ™‡Æ±‡Øç‡Æ±‡Æø ‡Æï‡Øá‡Æü‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç."
    }
  }
};

let CUR = "en";

function setLang(l) {
  if (!LANG[l]) return;
  CUR = l;
  
  document.getElementById("chatbot-header").innerText = LANG[l].header;
  document.getElementById("chatbot-text").placeholder = LANG[l].input;
  
  const waBtn = document.getElementById("whatsapp-btn");
  if(waBtn) waBtn.innerText = LANG[l].wa;
  
  quickBox.innerHTML = "";
  LANG[l].quick.forEach(q => {
    const b = document.createElement("button");
    b.innerText = q;
    b.className = "px-3 py-1 text-xs rounded bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600 transition";
    b.onclick = () => quick(q);
    quickBox.appendChild(b);
  });
}

function addMsg(t, u) {
  const d = document.createElement("div");
  d.className = `max-w-[85%] my-1 px-3 py-2 rounded text-sm break-words ${u ? "bg-blue-600 text-white ml-auto" : "bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100"}`;
  // Allow HTML for links (like YouTube)
  d.innerHTML = t.replace(/\n/g, "<br>");
  msgs.appendChild(d);
  msgs.scrollTop = msgs.scrollHeight;
}

function botReply(t) {
  t = t.toLowerCase();
  const r = LANG[CUR].reply;
  
  if (t.includes("goat") || t.includes("‡∞Æ‡±á‡∞ï") || t.includes("‡§¨‡§ï‡§∞‡•Ä") || t.includes("‡ÆÜ‡Æü‡ØÅ")) return r.goat;
  if (t.includes("sheep") || t.includes("‡∞ó‡±ä‡∞∞‡±ç‡∞∞‡±Ü") || t.includes("‡§≠‡•á‡§°‡§º") || t.includes("‡Æö‡ØÜ‡ÆÆ‡Øç‡ÆÆ‡Æ±‡Æø")) return r.sheep;
  if (t.includes("price") || t.includes("‡∞ß‡∞∞") || t.includes("‡§ï‡•Ä‡§Æ‡§§") || t.includes("‡Æµ‡Æø‡Æ≤‡Øà")) return r.price;
  if (t.includes("youtube") || t.includes("‡∞Ø‡±Ç‡∞ü‡±ç‡∞Ø‡±Ç‡∞¨‡±ç") || t.includes("‡§Ø‡•Ç‡§ü‡•ç‡§Ø‡•Ç‡§¨") || t.includes("‡ÆØ‡ØÇ‡Æü‡Æø‡ÆØ‡ØÇ‡Æ™‡Øç")) return r.youtube;
  if (t.includes("address") || t.includes("‡∞ö‡∞ø‡∞∞‡±Å‡∞®‡∞æ‡∞Æ‡∞æ") || t.includes("‡§™‡§§‡§æ") || t.includes("‡ÆÆ‡ØÅ‡Æï‡Æµ‡Æ∞‡Æø")) return r.address;
  if (t.includes("contact") || t.includes("‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø") || t.includes("‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï") || t.includes("‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ")) return r.contact;
  
  return r.default;
}

function sendChat() {
  const i = document.getElementById("chatbot-text");
  if (!i.value.trim()) return;
  addMsg(i.value, true);
  setTimeout(() => addMsg(botReply(i.value), false), 300);
  i.value = "";
}

function quick(t) {
  addMsg(t, true);
  setTimeout(() => addMsg(botReply(t), false), 300);
}

// Initialize
setLang("en");
</script>


    <script>
      let deferredPrompt;
      const installBtn = document.createElement('button');
      installBtn.textContent = 'üì≤ Install App';
      installBtn.style.display = 'none';
      installBtn.style.position = 'fixed';
      installBtn.style.bottom = '20px';
      installBtn.style.right = '20px';
      installBtn.style.padding = '10px 20px';
      installBtn.style.backgroundColor = '#4CAF50';
      installBtn.style.color = 'white';
      installBtn.style.border = 'none';
      installBtn.style.borderRadius = '5px';
      installBtn.style.zIndex = '1000';
      installBtn.style.cursor = 'pointer';
      document.body.appendChild(installBtn);

      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js')
            .then(reg => console.log('Service Worker registered'))
            .catch(err => console.log('Service Worker Error:', err));
        });
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        installBtn.style.display = 'block';
      });

      installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log(`User response: ${outcome}`);
          deferredPrompt = null;
          installBtn.style.display = 'none';
        }
      });

      window.addEventListener('appinstalled', () => {
        installBtn.style.display = 'none';
        console.log('PWA installed');
      });
    </script>
    
</body>
</html>

<!-- ================= ULTIMATE SPLASH ================= -->
<div id="splash-screen" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#16a34a,#065f46);">
    <div style="text-align:center;">
        <img src="IMG_20251229_120150.jpg" style="width:120px;height:120px;object-fit:contain;animation:bounce 1.5s infinite;">
        <h1 style="margin-top:20px;font-size:22px;font-weight:bold;color:white;">LivestockMart</h1>
    </div>
</div>

<script>
window.addEventListener("load", function() {
    setTimeout(function() {
        var splash = document.getElementById("splash-screen");
        if (splash) {
            splash.style.transition = "0.6s ease";
            splash.style.opacity = "0";
            setTimeout(function() {
                splash.remove();
                var auth = document.getElementById("auth-screen");
                if (auth) auth.classList.remove("hidden");
            }, 600);
        }
    }, 1500);
});

document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll("img").forEach(img => {
        img.setAttribute("loading", "lazy");
        img.setAttribute("decoding", "async");
    });
});
</script>
<!-- ==================================================== -->
